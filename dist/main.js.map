{"version":3,"sources":["webpack://3d-renderer/./src/Rendering/quaternion.ts","webpack://3d-renderer/./src/Etc/mathFunctions.ts","webpack://3d-renderer/./src/File/fileLoader.ts","webpack://3d-renderer/./src/Rendering/vector.ts","webpack://3d-renderer/./src/Rendering/matrix.ts","webpack://3d-renderer/./src/Rendering/transform.ts","webpack://3d-renderer/./src/Rendering/node.ts","webpack://3d-renderer/./src/Rendering/model.ts","webpack://3d-renderer/./src/Animation/JointTransform.ts","webpack://3d-renderer/./src/Etc/time.ts","webpack://3d-renderer/./src/Animation/animator.ts","webpack://3d-renderer/./src/Animation/animatedModel.ts","webpack://3d-renderer/./src/Rendering/renderer.ts","webpack://3d-renderer/./src/Animation/animatedRenderer.ts","webpack://3d-renderer/./src/Animation/keyframe.ts","webpack://3d-renderer/./src/Animation/animation.ts","webpack://3d-renderer/./src/Etc/webglUtils.ts","webpack://3d-renderer/./src/Animation/joint.ts","webpack://3d-renderer/./src/Rendering/camera.ts","webpack://3d-renderer/./src/main.ts","webpack://3d-renderer/./src/Rendering/scene.ts","webpack://3d-renderer/./src/Rendering/staticRenderer.ts"],"names":["x","y","z","w","this","normalize","magnitude","Math","sqrt","conjugate","rotate","c1","cos","s1","sin","c2","s2","c3","s3","c1c2","s1s2","q","Quaternion","multiply","toMatrix4","sqw","sqx","sqy","sqz","m00","m11","m22","tmp1","tmp2","m10","m01","m20","m02","Matrix4","fromMatrix4","m","diagonal","getElementAt","w4","x4","y4","z4","interpolate","a","b","step","cosHalfTheta","abs","halfTheta","acos","sinHalfTheta","ratioA","ratioB","degToRad","d","PI","lerp","ArrayType","ComponentType","v","len","Vector3","divide","add","subtract","scalar","console","error","dotProduct","vectorCrossProduct","zero","forward","backward","up","down","left","right","Vector2","Vector4","r0c0","r0c1","r0c2","r0c3","r1c0","r1c1","r1c2","r1c3","r2c0","r2c1","r2c2","r2c3","r3c0","r3c1","r3c2","r3c3","elements","row","col","setElementAt","value","flatten","makeIdentity","makeScale","makeTranslation","makeXRotation","angleInRadians","sine","cosine","makeYRotation","makeZRotation","makePerspective","fovInRadians","aspectRatio","zNear","zFar","f","tan","rangeInv","makeLookAtMatrix","position","target","zAxis","xAxis","yAxis","makeViewMatrix","eye","forwardZ","rightX","upY","multiplyMatrix4ByVector4","multiplyMatrices4","multiplied","i","j","transpose","transposed","copy","copied","inverse","m03","m12","m13","m21","m23","m30","m31","m32","m33","tmp_0","tmp_1","tmp_2","tmp_3","tmp_4","tmp_5","tmp_6","tmp_7","tmp_8","tmp_9","tmp_10","tmp_11","tmp_12","tmp_13","tmp_14","tmp_15","tmp_16","tmp_17","tmp_18","tmp_19","tmp_20","tmp_21","tmp_22","tmp_23","t0","t1","t2","t3","compose","translation","scale","quaternion","result","x2","y2","z2","xx","xy","xz","yy","yz","zz","wx","wy","wz","decompose","rotation","sliceX","slice","sliceY","sliceZ","sx","sy","sz","determinate","matrix","invSX","invSY","invSZ","reset","computeDirectionVectors","_up","_right","_forward","shouldComputeDirections","rotationMatrix","translate","angles","setRotation","updateLocalMatrix","localMatrix","translationMatrix","scaleMatrix","updateWorldMatrix","parentMatrix","worldMatrix","getWorldMatrix","getLocalMatrix","transform","Transform","children","setParent","parent","index","indexOf","splice","addChild","child","push","updateTransforms","forEach","renderer","bufferData","buffer","data","bufferType","ctx","getContext","bindBuffer","WebGLRenderingContext","STATIC_DRAW","render","camera","BaseNode","JointTransform","computeTime","now","deltaTime","time","model","doAnimation","animation","currentTime","update","increaseAnimationTime","Time","currentPose","computeCurrentAnimationPose","applyPoseToJoints","rootJoint","lengthInSeconds","getPreviousAndNextFrames","previousFrame","nextFrame","calculateProgression","interpolatePoses","joint","currentTransform","name","animatedMatrix","inverseBindMatrix","allKeyFrames","keyframes","previous","next","length","timestamp","totalTime","key","pose","positions","normals","textureCoords","indices","joints","weights","jointCount","createBuffer","indexCount","ELEMENT_ARRAY_BUFFER","ARRAY_BUFFER","boneTexture","createTexture","bindTexture","TEXTURE_2D","texParameteri","TEXTURE_MIN_FILTER","NEAREST","TEXTURE_MAG_FILTER","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","animator","Animator","arr","Float32Array","flattenJointMatrices","offset","id","set","texImage2D","RGBA","FLOAT","Model","context","program","positionAttributeLocation","getAttribLocation","texCoordsAttributeLocation","normalsAttributeLocation","jointsAttributeLocation","weightsAttributeLocation","worldMatrixUniformLocation","getUniformLocation","viewMatrixUniformLocation","projectionMatrixUniformLocation","worldInverseTransposeMatrixLocation","reverseLightDirectionLocation","jointTextureLocation","jointCountLocation","loadTexture","img","texture","UNSIGNED_BYTE","generateMipmap","loadTexture2","color","Uint8Array","clear","clearColor","COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","projectionMatrix","getPerspectiveMatrix","viewMatrix","viewport","canvas","width","height","useProgram","enable","CULL_FACE","DEPTH_TEST","uniform1i","uniform1f","uniformMatrix4fv","worldInverse","reverseLightDirectionVector","uniform3fv","enableVertexAttribArray","vertexAttribPointer","activeTexture","TEXTURE0","TEXTURE1","drawElements","TRIANGLES","UNSIGNED_SHORT","BaseRenderer","fromGLTFAnimation","anim","samples","animationLength","animationName","jointsAnimations","map","s","t","p","jointAnimation","values","jointName","HumbleKeyframe","HumbleAnimation","loadFromScript","gl","shaderElem","shaderType","shader","createShader","shaderSource","text","compileShader","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","createProgram","vertexShader","fragmentShader","attachShader","linkProgram","getProgramParameter","LINK_STATUS","deleteProgram","inverseMatrix","loadGltf","url","meshId","getDataFromAccessors","accessorIndex","file","buffers","accessor","accessors","bufferView","bufferViews","byteOffset","byteLength","type","BYTES_PER_ELEMENT","SHORT","Int16Array","UNSIGNED_INTEGER","Uint32Array","Uint16Array","getTypedArray","componentType","max","min","positionData","normalData","texCoordData","indicesData","jointData","weightData","animations","loadJson","gltf","baseURL","URL","location","href","Promise","all","uri","loadArrayBuffer","binaryBuffers","meshes","primitives","primitive","positionAccessorIndex","attributes","normalAccessorIndex","texCoordAccessorIndex","jointAccessorIndex","weightAccessorIndex","indicesIndex","skins","skin","actualJointNodes","nodes","isRoot","inverseMatricesAccessor","inverseBindMatrices","inverseMatricesBufferView","inverseBindMatricesData","Array","ibm","quat","Joint","find","maxLength","animationData","jointAnimationsByName","channels","channel","sampler","samplers","inputData","input","outputData","output","node","jointAnimData","timestampIndex","componentLen","from","path","toLowerCase","interpolationMethod","interpolation","Object","loadText","fetch","json","loadImage","resolve","reject","Image","addEventListener","src","arrayBuffer","scene","theModel","staticRenderer","animatedRenderer","fieldOfView","near","far","Camera","getActiveCamera","setActiveCamera","computePerspectiveMatrix","perspectiveMatrix","activeCamera","globalLightDirection","rootNodes","renderables","rootNode","renderable","window","onload","onerror","errorMsg","lineNumber","alert","viewElements","loadingState","style","visibility","loadedState","canvasElem","document","querySelector","vertexShaderElemStatic","fragmentShaderElemStatic","vertexShaderElemAnimated","fragmentShaderElemAnimated","getExtension","Error","webglUtils","VERTEX_SHADER","FRAGMENT_SHADER","StaticRenderer","AnimatedRenderer","aspect","clientWidth","clientHeight","yFov","firsPersonCamera","cameraObj","currentRotationAngles","Scene","setup","FileLoader","loadResources","then","gltfModel","AnimatedModel","setupStaticModel","newOption","createElement","animationSelect","appendChild","buildAnimationOptions","keys","event","controls","mouseMoved","movementY","movementX","Rotate","requestPointerLock","pointerLockElement","removeEventListener","createEventHandlers","requestAnimationFrame","gameLoop","forwardVelocity","rightVelocity","maxXRotation","minXRotation","cameraSpeed","mouseSensibility","Move","direction","cam","speed","velocity","rotationAmount","xRotationElement","yRotationElement","zRotationElement"],"mappings":"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","file":"main.js","sourcesContent":["import { Matrix4 } from \"./matrix\";\r\n\r\n//Quaternions are a way to represent rotation (among other transformations)\r\n//for future reference: \r\n// http://www.euclideanspace.com/maths/geometry/rotations/conversions/quaternionToMatrix/\r\n// http://www.euclideanspace.com/maths/geometry/rotations/conversions/matrixToQuaternion/index.htm\r\n// https://www.youtube.com/watch?v=d4EgbgTm0Bg\r\n\r\n// Quaternions are too much for my limited knowledge right now...\r\n// Im not really comfortable with all the maths going on here, i might come back later to try and understand \r\n// The code here is mostly ported from http://www.euclideanspace.com\r\n// Altough quaternions can represent other transformations, we are only representing rotation here...\r\nexport class Quaternion {\r\n    x: number; // imaginary-i\r\n    y: number; // imaginary-j\r\n    z: number; // imaginary-k\r\n    w: number; // real part\r\n    constructor(x?: number, y?: number, z?: number, w?: number) {\r\n        this.x = x ?? 0;\r\n        this.y = y ?? 0;\r\n        this.z = z ?? 0;\r\n        this.w = w ?? 1;\r\n        this.normalize();\r\n    }\r\n    normalize(): void {\r\n        //vector-like normalization...\r\n        //find the \"vector\" magnitude, then divide by magnitude\r\n        const magnitude = Math.sqrt((this.x * this.x) + (this.y * this.y) + (this.z * this.z) + (this.w * this.w));\r\n\r\n        if (magnitude > 0) {\r\n            this.x /= magnitude;\r\n            this.y /= magnitude;\r\n            this.z /= magnitude;\r\n            this.w /= magnitude;\r\n        }\r\n    }\r\n    conjugate(): void {\r\n        this.x = -this.x;\r\n        this.y = -this.y;\r\n        this.z = -this.z;\r\n        this.w = -this.w;\r\n    }\r\n\r\n    //heading: y-axis\r\n    //attitude: z-axis\r\n    //bank: x-axis\r\n    //assuming angles in radians here\r\n    rotate(x: number, y: number, z: number): void {\r\n        const c1 = Math.cos(y / 2);\r\n        const s1 = Math.sin(y / 2);\r\n        const c2 = Math.cos(z / 2);\r\n        const s2 = Math.sin(z / 2);\r\n        const c3 = Math.cos(x / 2);\r\n        const s3 = Math.sin(x / 2);\r\n        const c1c2 = c1 * c2;\r\n        const s1s2 = s1 * s2;\r\n\r\n        let q = new Quaternion(\r\n            c1c2 * s3 + s1s2 * c3, //x\r\n            s1 * c2 * c3 + c1 * s2 * s3, //y\r\n            c1 * s2 * c3 - s1 * c2 * s3, //z\r\n            c1c2 * c3 - s1s2 * s3 //w\r\n        );\r\n\r\n        this.multiply(q);\r\n    }\r\n\r\n    multiply(q: Quaternion) {\r\n        let x = q.x * this.w + q.y * this.z - q.z * this.y + q.w * this.x;\r\n        let y = -q.x * this.z + q.y * this.w + q.z * this.x + q.w * this.y;\r\n        let z = q.x * this.y - q.y * this.x + q.z * this.w + q.w * this.z;\r\n        let w = -q.x * this.x - q.y * this.y - q.z * this.z + q.w * this.w;\r\n\r\n        this.x = x;\r\n        this.y = y;\r\n        this.z = z;\r\n        this.w = w;\r\n\r\n    }\r\n    /**\r\n     * Convert from quaternion to a rotation matrix\r\n     * @returns \r\n     */\r\n    toMatrix4(): Matrix4 {\r\n        this.normalize(); // to represent rotations, quaternions must be normalized, or will mess up the scale and/or translation!\r\n\r\n        let sqw = this.w * this.w;\r\n        let sqx = this.x * this.x;\r\n        let sqy = this.y * this.y;\r\n        let sqz = this.z * this.z;\r\n\r\n        let m00 = (sqx - sqy - sqz + sqw);\r\n        let m11 = (-sqx + sqy - sqz + sqw);\r\n        let m22 = (-sqx - sqy + sqz + sqw);\r\n\r\n        let tmp1 = this.x * this.y;\r\n        let tmp2 = this.z * this.w;\r\n        let m10 = 2.0 * (tmp1 + tmp2);\r\n        let m01 = 2.0 * (tmp1 - tmp2);\r\n\r\n        tmp1 = this.x * this.z;\r\n        tmp2 = this.y * this.w;\r\n        let m20 = 2.0 * (tmp1 - tmp2);\r\n        let m02 = 2.0 * (tmp1 + tmp2);\r\n        tmp1 = this.y * this.z;\r\n        tmp2 = this.x * this.w;\r\n        let m21 = 2.0 * (tmp1 + tmp2);\r\n        let m12 = 2.0 * (tmp1 - tmp2);\r\n       \r\n        return new Matrix4(\r\n            m00, m10, m20, 0,\r\n            m01, m11, m21, 0,\r\n            m02, m12, m22, 0,\r\n            0, 0, 0, 1\r\n        );\r\n    }\r\n\r\n\r\n    /**\r\n     * Extracts rotation components from a matrix 4x4\r\n     * @param m \r\n     * @returns \r\n     */\r\n    static fromMatrix4(m: Matrix4): Quaternion {\r\n        let x: number;\r\n        let y: number;\r\n        let z: number;\r\n        let w: number;\r\n\r\n        const diagonal = m.getElementAt(0, 0) + m.getElementAt(1, 1) + m.getElementAt(2, 2);\r\n        if (diagonal > 0) {\r\n            let w4 = (Math.sqrt(diagonal + 1) * 2);\r\n            x = (m.getElementAt(2, 1) - m.getElementAt(1, 2)) / w4;\r\n            y = (m.getElementAt(0, 2) - m.getElementAt(2, 0)) / w4;\r\n            z = (m.getElementAt(1, 0) - m.getElementAt(0, 1)) / w4;\r\n            w = w4 / 4;\r\n        } else if ((m.getElementAt(0, 0) > m.getElementAt(1, 1)) && (m.getElementAt(0, 0) > m.getElementAt(2, 2))) {\r\n            const x4 = (Math.sqrt(1 + m.getElementAt(0, 0) - m.getElementAt(1, 1) - m.getElementAt(2, 2)) * 2);\r\n            x = x4 / 4;\r\n            y = (m.getElementAt(0, 1) + m.getElementAt(1, 0)) / x4;\r\n            z = (m.getElementAt(0, 2) + m.getElementAt(2, 0)) / x4;\r\n            w = (m.getElementAt(2, 1) - m.getElementAt(1, 2)) / x4;\r\n        } else if (m.getElementAt(1, 1) > m.getElementAt(2, 2)) {\r\n            const y4 = (Math.sqrt(1 + m.getElementAt(1, 1) - m.getElementAt(0, 0) - m.getElementAt(2, 2)) * 2);\r\n            x = (m.getElementAt(0, 1) + m.getElementAt(1, 0)) / y4;\r\n            y = y4 / 4;\r\n            z = (m.getElementAt(1, 2) + m.getElementAt(2, 1)) / y4;\r\n            w = (m.getElementAt(0, 2) - m.getElementAt(2, 0)) / y4;\r\n        } else {\r\n            const z4 = (Math.sqrt(1 + m.getElementAt(2, 2) - m.getElementAt(0, 0) - m.getElementAt(1, 1)) * 2);\r\n            x = (m.getElementAt(0, 2) + m.getElementAt(2, 0)) / z4;\r\n            y = (m.getElementAt(1, 2) + m.getElementAt(2, 1)) / z4;\r\n            z = z4 / 4;\r\n            w = (m.getElementAt(1, 0) - m.getElementAt(0, 1)) / z4;\r\n        }\r\n        return new Quaternion(x, y, z, w);\r\n    };\r\n\r\n    /**\r\n     * \r\n     * @param a 'from' parameter\r\n     * @param b 'to' parameter\r\n     * @param step step between 0 ~ 1. 0 returns a, 1 returns b, 0.5 returns the midpoint between a and b\r\n     * @returns \r\n     */\r\n    static interpolate(a: Quaternion, b: Quaternion, step: number): Quaternion {\r\n\r\n        let q = new Quaternion();\r\n        const cosHalfTheta = (a.x * b.x) + (a.y * b.y) + (a.z * b.z) + (a.w * b.w);\r\n        if (Math.abs(cosHalfTheta) >= 1.0) {\r\n            q.w = a.w;\r\n            q.x = a.x;\r\n            q.y = a.y;\r\n            q.z = a.z;\r\n            return q;\r\n        }\r\n\r\n        const halfTheta = Math.acos(cosHalfTheta);\r\n        const sinHalfTheta = Math.sqrt(1.0 - cosHalfTheta * cosHalfTheta);\r\n        // if theta = 180 degrees then result is not fully defined\r\n        // we could rotate around any axis normal to qa or qb\r\n        if (Math.abs(sinHalfTheta) < 0.00001) { // fabs is floating point absolute\r\n            q.w = (a.w * 0.5 + q.w * 0.5);\r\n            q.x = (a.x * 0.5 + q.x * 0.5);\r\n            q.y = (a.y * 0.5 + q.y * 0.5);\r\n            q.z = (a.z * 0.5 + q.z * 0.5);\r\n            return q;\r\n        }\r\n\r\n        const ratioA = Math.sin((1 - step) * halfTheta) / sinHalfTheta;\r\n        const ratioB = Math.sin(step * halfTheta) / sinHalfTheta;\r\n        //calculate Quaternion.\r\n        q.w = (a.w * ratioA + b.w * ratioB);\r\n        q.x = (a.x * ratioA + b.x * ratioB);\r\n        q.y = (a.y * ratioA + b.y * ratioB);\r\n        q.z = (a.z * ratioA + b.z * ratioB);\r\n        return q;\r\n    }\r\n}","export function radToDeg(r: number): number {\r\n    return r * 180 / Math.PI;\r\n}\r\n\r\nexport function degToRad(d: number): number {\r\n    return d * Math.PI / 180;\r\n}\r\n\r\nexport function randomIntFromInterval(min: number, max: number) { // min and max included \r\n    return Math.floor(Math.random() * (max - min + 1) + min)\r\n}\r\n\r\n/**\r\n * \r\n * @param a 'from' parameter\r\n * @param b 'to' parameter\r\n * @param step  step between 0 ~ 1. 0 returns a, 1 returns b, 0.5 returns the midpoint between a and b\r\n */\r\nexport function lerp(a: number, b: number, step: number) {\r\n    let iStep = 1 - step;\r\n    return  (iStep * a) + (step * b);\r\n}","import { Joint } from \"../Animation/joint\";\r\nimport { Matrix4 } from \"../Rendering/matrix\";\r\nimport { Quaternion } from \"../Rendering/quaternion\";\r\nimport { Vector3, Vector4 } from \"../Rendering/vector\";\r\nimport { Transform } from \"../Rendering/transform\";\r\n\r\nexport class FileLoader {\r\n\r\n    //TODO: come back here later!\r\n    // refactor to:\r\n    // get a \"processed gltf file\"\r\n    // expose methods like getMeshes, getAnimations, getJoints, etc\r\n    // maybe something to load a whole Scene?\r\n    static async loadGltf(url: string, meshId: number) {\r\n        \r\n        let result: GLTFModel = {\r\n            positionData: null,\r\n            normalData: null,\r\n            texCoordData: null,\r\n            indicesData: null,\r\n            jointData: null,\r\n            weightData: null,\r\n            rootJoint: null,\r\n            jointCount: 0,\r\n            animations: []\r\n        };\r\n\r\n        let inverseBindMatricesData: Float32Array;\r\n        let gltf = await this.loadJson<GLTFFile>(url);\r\n        const baseURL = new URL(url, location.href);\r\n        let binaryBuffers = await Promise.all(gltf.buffers.map((buffer) => {\r\n            const url = new URL(buffer.uri, baseURL.href);\r\n            return this.loadArrayBuffer(url.href);\r\n        }));\r\n\r\n        //there is just one mesh so far...\r\n        // gltf.meshes.forEach((mesh) => {\r\n        let mesh = gltf.meshes[meshId];\r\n        mesh.primitives.forEach((primitive) => {\r\n            const positionAccessorIndex = primitive.attributes[\"POSITION\"];\r\n            const normalAccessorIndex = primitive.attributes[\"NORMAL\"];\r\n            const texCoordAccessorIndex = primitive.attributes[\"TEXCOORD_0\"];\r\n            const jointAccessorIndex = primitive.attributes[\"JOINTS_0\"];\r\n            const weightAccessorIndex = primitive.attributes[\"WEIGHTS_0\"];\r\n            const indicesIndex = primitive.indices;\r\n\r\n            result.positionData = getDataFromAccessors(positionAccessorIndex, gltf, binaryBuffers).data as Float32Array;\r\n            result.normalData = getDataFromAccessors(normalAccessorIndex, gltf, binaryBuffers).data as Float32Array;\r\n            result.texCoordData = getDataFromAccessors(texCoordAccessorIndex, gltf, binaryBuffers).data as Float32Array;\r\n            result.jointData = getDataFromAccessors(jointAccessorIndex, gltf, binaryBuffers).data as Uint8Array;\r\n            result.weightData = getDataFromAccessors(weightAccessorIndex, gltf, binaryBuffers).data as Float32Array;\r\n            result.indicesData = getDataFromAccessors(indicesIndex, gltf, binaryBuffers).data as Uint16Array;\r\n        });\r\n\r\n        //now the skins...\r\n        //there is only one skin so far...\r\n        let joints: Joint[];\r\n        gltf.skins.forEach((skin) => {\r\n            let actualJointNodes = skin.joints.map(index => gltf.nodes[index]);\r\n            actualJointNodes[0].isRoot = true;\r\n            const inverseMatricesAccessor = gltf.accessors[skin.inverseBindMatrices];\r\n            const inverseMatricesBufferView = gltf.bufferViews[inverseMatricesAccessor.bufferView];\r\n            const buffer = binaryBuffers[inverseMatricesBufferView.buffer];\r\n            inverseBindMatricesData = new Float32Array(buffer, inverseMatricesBufferView.byteOffset, inverseMatricesBufferView.byteLength / Float32Array.BYTES_PER_ELEMENT);\r\n            let inverseBindMatrices = new Array<Matrix4>(inverseBindMatricesData.length / 16);\r\n\r\n            for (let i = 0; i < inverseBindMatrices.length; i++) {\r\n                let offset = (16 * i);\r\n                inverseBindMatrices[i] = new Matrix4(\r\n                    inverseBindMatricesData[0 + offset], inverseBindMatricesData[1 + offset], inverseBindMatricesData[2 + offset], inverseBindMatricesData[3 + offset],\r\n                    inverseBindMatricesData[4 + offset], inverseBindMatricesData[5 + offset], inverseBindMatricesData[6 + offset], inverseBindMatricesData[7 + offset],\r\n                    inverseBindMatricesData[8 + offset], inverseBindMatricesData[9 + offset], inverseBindMatricesData[10 + offset], inverseBindMatricesData[11 + offset],\r\n                    inverseBindMatricesData[12 + offset], inverseBindMatricesData[13 + offset], inverseBindMatricesData[14 + offset], inverseBindMatricesData[15 + offset]\r\n                );\r\n            }\r\n            joints = new Array<Joint>(actualJointNodes.length);\r\n\r\n            //fill a Joint array\r\n            for (let i = 0; i < actualJointNodes.length; i++) {\r\n                let position = new Vector3(0, 0, 0);\r\n                let rotation = new Vector4(0, 0, 0, 1);\r\n                let scale = new Vector3(1, 1, 1);\r\n\r\n                if (actualJointNodes[i].translation) {\r\n                    position.x = actualJointNodes[i].translation[0];\r\n                    position.y = actualJointNodes[i].translation[1];\r\n                    position.z = actualJointNodes[i].translation[2];\r\n                }\r\n\r\n                if (actualJointNodes[i].rotation) {\r\n                    rotation.x = actualJointNodes[i].rotation[0];\r\n                    rotation.y = actualJointNodes[i].rotation[1];\r\n                    rotation.z = actualJointNodes[i].rotation[2];\r\n                    rotation.w = actualJointNodes[i].rotation[3];\r\n                }\r\n\r\n                if (actualJointNodes[i].scale) {\r\n                    scale.x = actualJointNodes[i].scale[0];\r\n                    scale.y = actualJointNodes[i].scale[1];\r\n                    scale.z = actualJointNodes[i].scale[2];\r\n                }\r\n                \r\n                let ibm = inverseBindMatrices[i];\r\n                let quat = new Quaternion(rotation.x, rotation.y, rotation.z, rotation.w);\r\n                let transform = new Transform(position, quat, scale);\r\n\r\n                joints[i] = new Joint(\r\n                    i,\r\n                    actualJointNodes[i].name,\r\n                    transform,\r\n                    ibm\r\n                );\r\n            }\r\n\r\n            //get tree-like hierarchy done\r\n            for (let i = 0; i < actualJointNodes.length; i++) {\r\n                if (actualJointNodes[i].children) {\r\n                    actualJointNodes[i].children.forEach(child => {\r\n                        let j = joints.find(x => x.name === gltf.nodes[child].name);\r\n                        j.setParent(joints[i]);\r\n                    });\r\n                }\r\n            }\r\n            //i think the first joint is always the root?\r\n            result.rootJoint = joints[0];\r\n            result.jointCount = joints.length;\r\n        });\r\n\r\n        function getDataFromAccessors(accessorIndex: number, file: GLTFFile, buffers: ArrayBuffer[]) {\r\n\r\n            const accessor = file.accessors[accessorIndex];\r\n            const bufferView = file.bufferViews[accessor.bufferView];\r\n            const buffer = buffers[bufferView.buffer];\r\n            const data = getTypedArray(buffer, bufferView.byteOffset, bufferView.byteLength, accessor.componentType);\r\n\r\n            return {\r\n                max: accessor.max,\r\n                min: accessor.min,\r\n                type: accessor.type,\r\n                data: data\r\n            };\r\n\r\n        }\r\n\r\n        function getTypedArray(buffer: ArrayBuffer, byteOffset: number, byteLength: number, type: ArrayType) {\r\n            switch (type) {\r\n                case ArrayType.FLOAT:\r\n                    return new Float32Array(buffer, byteOffset, byteLength / Float32Array.BYTES_PER_ELEMENT);\r\n                case ArrayType.SHORT:\r\n                    return new Int16Array(buffer, byteOffset, byteLength / Int16Array.BYTES_PER_ELEMENT);\r\n                case ArrayType.UNSIGNED_BYTE:\r\n                    return new Uint8Array(buffer, byteOffset, byteLength / Uint8Array.BYTES_PER_ELEMENT);\r\n                case ArrayType.UNSIGNED_INTEGER:\r\n                    return new Uint32Array(buffer, byteOffset, byteLength / Uint32Array.BYTES_PER_ELEMENT);\r\n                case ArrayType.UNSIGNED_SHORT:\r\n                    return new Uint16Array(buffer, byteOffset, byteLength / Uint16Array.BYTES_PER_ELEMENT);\r\n                default:\r\n                    console.error(\"ComponentType not found: \", type);\r\n                    return null;\r\n            }\r\n        }\r\n\r\n        //now the animations:\r\n        //for each animation\r\n        //  - get name, if there is no name we call it something like anim1\r\n        //  - iterate through channels of the animation\r\n        //  - select the respective sampler\r\n        //  - load timestamps from input, values from output using 'getDataFromAccessors' and the interpolation method\r\n        //  - save which node/joint to animate and which 'path'(translation, rotation, scale)\r\n        gltf.animations.forEach((animation, i) => {\r\n            let maxLength = 0;\r\n            let animationData: SkeletonAnimationData = {} as SkeletonAnimationData;\r\n            let jointAnimationsByName: { [key: string]: JointAnimationData } = {};\r\n\r\n            animationData.animationName = animation.name ? animation.name : \"anim\" + i;\r\n            animation.channels.forEach((channel, j) => {\r\n                let sampler = animation.samplers[channel.sampler];\r\n                let inputData = getDataFromAccessors(sampler.input, gltf, binaryBuffers);\r\n                let outputData = getDataFromAccessors(sampler.output, gltf, binaryBuffers);\r\n                let node = gltf.nodes[channel.target.node];\r\n\r\n                let jointName = node.name ? node.name : \"joint\" + j;\r\n                //add to dictionary, if it is not already\r\n                if (!jointAnimationsByName[jointName]) {\r\n                    jointAnimationsByName[jointName] = { jointName: jointName } as JointAnimationData;\r\n                }\r\n\r\n                let jointAnimData = jointAnimationsByName[jointName];\r\n                let samples: AnimationSampleData[] = [];\r\n\r\n                inputData.data.forEach((timestamp, timestampIndex) => {\r\n                    timestamp *= 1; //debug\r\n                    let componentLen = ComponentType[outputData.type as keyof typeof ComponentType];\r\n                    let len = timestampIndex * componentLen;\r\n                    maxLength = Math.max(maxLength, timestamp);\r\n                    let arr: number[] = Array.from(outputData.data.slice(len, len + componentLen));\r\n                    samples.push({ timestamp: timestamp, values: arr });\r\n                });\r\n\r\n                //TODO: replace this with something like:\r\n                //jointAnimData.[path] = {interpolationMethod: sampler.interpolation, samples};\r\n                switch (channel.target.path.toLowerCase()) {\r\n                    case \"translation\":\r\n                        jointAnimData.translation = { interpolationMethod: sampler.interpolation, samples };\r\n                        break;\r\n                    case \"rotation\":\r\n                        jointAnimData.rotation = { interpolationMethod: sampler.interpolation, samples };\r\n                        break;\r\n                    case \"scale\":\r\n                        jointAnimData.scale = { interpolationMethod: sampler.interpolation, samples };\r\n                        break;\r\n                    default:\r\n                        console.error(\"path not implemented: \", channel.target.path);\r\n                        break;\r\n                }\r\n            });\r\n\r\n            animationData.jointsAnimations = Object.values(jointAnimationsByName);\r\n            animationData.animationLength = maxLength;\r\n            result.animations.push(animationData);\r\n        });\r\n\r\n        return result;\r\n    }\r\n\r\n    static async loadText(url: string) {\r\n        let response = await fetch(url);\r\n        return response.text();\r\n    }\r\n\r\n    static async loadJson<T>(url: string) {\r\n        let response = await fetch(url);\r\n        return response.json() as Promise<T>;\r\n    }\r\n\r\n    static async loadImage(url: string): Promise<HTMLImageElement> {\r\n        return new Promise((resolve, reject) => {\r\n            let img = new Image();\r\n            img.addEventListener('load', () => {\r\n                resolve(img);\r\n            });\r\n            img.src = url;\r\n        });\r\n    }\r\n\r\n    static async loadArrayBuffer(url: string) {\r\n        const response = await fetch(url);\r\n        return response.arrayBuffer();\r\n    }\r\n}\r\n\r\n//Creating GLTF types whenever i need them\r\ninterface GLTFBuffer {\r\n    byteLength: number;\r\n    uri: string\r\n}\r\n\r\ninterface GLTFBufferView {\r\n    buffer: number;\r\n    byteLength: number;\r\n    byteOffset: number;\r\n}\r\n\r\ninterface GLTFAccessor {\r\n    bufferView: number;\r\n    componentType: number;\r\n    count: number;\r\n    max: number[];\r\n    min: number[];\r\n    type: string;\r\n}\r\n\r\ninterface GLTFMesh {\r\n    name: string;\r\n    primitives: GLTFPrimitive[]\r\n}\r\n\r\ninterface GLTFPrimitive {\r\n    attributes: GLTFAttributes;\r\n    indices: 5;\r\n    material: number;\r\n}\r\n\r\ninterface GLTFAttributes {\r\n    [key: string]: number;\r\n}\r\n\r\ninterface GLTFNode {\r\n    name: string;\r\n    rotation: number[]; //4-component quaternion\r\n    translation: number[]; //3-component vector\r\n    scale: number[];//3-component vector\r\n    skin: number; //skin index\r\n    mesh: number; //mesh index\r\n    children: number[]; // index of children nodes\r\n    isRoot?: boolean;\r\n}\r\n\r\ninterface GLTFSkin {\r\n    inverseBindMatrices: number; //this is the accessor index?\r\n    joints: number[]; //ids for node array\r\n    name: string;\r\n}\r\n\r\ninterface GLTFFile {\r\n    nodes: GLTFNode[];\r\n    skins: GLTFSkin[];\r\n    meshes: GLTFMesh[];\r\n    animations: GLTFAnimation[];\r\n    buffers: GLTFBuffer[];\r\n    accessors: GLTFAccessor[];\r\n    bufferViews: GLTFBufferView[];\r\n}\r\n\r\ninterface GLTFAnimation {\r\n    name: string;\r\n    channels: GLTFAnimationChannel[];\r\n    samplers: GLTFAnimationSampler[];\r\n\r\n}\r\n\r\ninterface GLTFAnimationChannel {\r\n    sampler: number;\r\n    target: GLTFAnimationTarget;\r\n}\r\n\r\ninterface GLTFAnimationTarget {\r\n    node: number;\r\n    path: string;\r\n}\r\n\r\ninterface GLTFAnimationSampler {\r\n    input: number;\r\n    interpolation: string;\r\n    output: number;\r\n}\r\n\r\n//Output struct\r\nexport interface GLTFModel {\r\n    positionData: Float32Array;\r\n    normalData: Float32Array;\r\n    texCoordData: Float32Array;\r\n    indicesData: Uint16Array;\r\n    jointData: Uint8Array;\r\n    weightData: Float32Array;\r\n    rootJoint: Joint;\r\n    jointCount: number;\r\n    animations: SkeletonAnimationData[];\r\n}\r\n\r\n//output struct\r\nexport interface SkeletonAnimationData {\r\n    animationLength: number;\r\n    animationName: string;\r\n    jointsAnimations: JointAnimationData[];\r\n}\r\n\r\n//output struct\r\nexport interface JointAnimationData {\r\n    jointName: string;\r\n    rotation: AnimationData;\r\n    scale: AnimationData;\r\n    translation: AnimationData;\r\n}\r\n\r\n//output struct\r\nexport interface AnimationData {\r\n    interpolationMethod: string;\r\n    samples: AnimationSampleData[];\r\n}\r\n//output struct\r\nexport interface AnimationSampleData {\r\n    timestamp: number; //in GLTF, time is in seconds\r\n    values: number[]; //flattened values, if scale or translation its 3 components, if rotation its 4(quaternion)\r\n}\r\n\r\nenum ArrayType {\r\n    BYTE = 5120,\r\n    UNSIGNED_BYTE = 5121,\r\n    SHORT = 5122,\r\n    UNSIGNED_SHORT = 5123,\r\n    UNSIGNED_INTEGER = 5125,\r\n    FLOAT = 5126\r\n}\r\n\r\nenum ComponentType {\r\n    SCALAR = 1,\r\n    VEC2 = 2,\r\n    VEC3 = 3,\r\n    VEC4 = 4,\r\n    MAT2 = 4,\r\n    MAT3 = 9,\r\n    MAT4 = 16,\r\n\r\n}","import { lerp } from \"../Etc/mathFunctions\";\r\n\r\n//TODO: add functions to do math in place?\r\nexport class Vector2 {\r\n    x: number;\r\n    y: number;\r\n    /**\r\n    * \r\n    * @param x If not supplied, defaults to 0\r\n    * @param y If not supplied, defaults to 0\r\n    */\r\n    constructor(x?: number, y?: number) {\r\n        this.x = x ?? 0;\r\n        this.y = y ?? 0;\r\n    }\r\n    /**\r\n     * \r\n     * The magnitude of a vector can be thought of the hypotenuse \r\n     * \r\n     * of the triangle formed by the x and y components.\r\n     *        \r\n     *           \r\n     *                 /| \r\n     *                / | \r\n     *               /  | \r\n     *          |v| /   | y \r\n     *             /    | \r\n     *            /_____|\r\n     *                x \r\n     * \r\n     * @param v The Vector\r\n     * @returns The length(magnitude) of the vector\r\n     */\r\n    static magnitude(v: Vector2): number {\r\n        return Math.sqrt((v.x * v.x) + (v.y * v.y));\r\n    }\r\n    /**\r\n     * Compute the unit vector for a given vector.\r\n     * \r\n     * @param v The vector\r\n     * @returns A new unit vector\r\n     */\r\n    static normalize(v: Vector2): Vector2 {\r\n        let len = Vector2.magnitude(v);\r\n        if (len > 0) {\r\n            return Vector2.divide(v, len);\r\n        } else {\r\n            return new Vector2(0, 0);\r\n        }\r\n    }\r\n    /**\r\n     * Simple vector addition. \r\n     * Just add each component of both vectors together.\r\n     * \r\n     * @param a First vector\r\n     * @param b Second Vector\r\n     * @returns Result vector from a + b\r\n     */\r\n    static add(a: Vector2, b: Vector2): Vector2 {\r\n        return new Vector2(\r\n            a.x + b.x,\r\n            a.y + b.y);\r\n    }\r\n    /**\r\n    * Simple vector subtraction. \r\n    * Just subtract each component of both vectors together.\r\n    * \r\n    * @param a First vector\r\n    * @param b Second Vector\r\n    * @returns Result vector from a - b\r\n    */\r\n    static subtract(a: Vector2, b: Vector2): Vector2 {\r\n        return new Vector2(\r\n            a.x - b.x,\r\n            a.y - b.y);\r\n    }\r\n    /**\r\n     * Multiply each vector component by a scalar factor.\r\n     * Can be thought of scaling a vector by a factor.\r\n     * \r\n     * @param v The vector\r\n     * @param scalar The scaling factor\r\n     * @returns New scaled vector\r\n     */\r\n    static multiply(v: Vector2, scalar: number): Vector2 {\r\n        return new Vector2(\r\n            v.x * scalar,\r\n            v.y * scalar);\r\n    }\r\n    /**\r\n     * Divide each vector component by a scalar factor.\r\n     * Can be thought of \"inverse\" of scaling a vector by a factor.\r\n     * \r\n     * @param v The vector\r\n     * @param scalar The \"inverse\" scaling factor\r\n     * @returns New scaled vector\r\n     */\r\n    static divide(v: Vector2, scalar: number): Vector2 {\r\n        if (scalar !== 0) {\r\n            return new Vector2(\r\n                v.x / scalar,\r\n                v.y / scalar);\r\n        } else {\r\n            console.error(\"Can't divide by zero, Vector2 was not divided!\")\r\n            return v;\r\n        }\r\n    }\r\n    /**\r\n     * Can be thought of as \"how aligned are two vectors\".\r\n     * \r\n     * Or like a projection(or the sadow) of a vector into another\r\n     * \r\n     * of the triangle formed by the x and y components.\r\n     * \r\n     *               \r\n     *               \r\n     *              Y|     B\r\n     *               |     /|\r\n     *               |    / | \r\n     *               |   /  |\r\n     *               |  /   |\r\n     *               | /    |\r\n     *               |/     |\r\n     *               |------>A.B---------->A\r\n     *               |----------------------->\t\r\n     *                                        X\r\n     * \r\n     * \r\n     * @param a Some vector\r\n     * @param b Some other vector\r\n     * @returns The result of the dot product\r\n     */\r\n    static dotProduct(a: Vector2, b: Vector2): number {\r\n        return (a.x * b.x) + (a.y * b.y);\r\n    }\r\n}\r\n\r\n//TODO: add functions to do math in place?\r\nexport class Vector3 extends Vector2 {\r\n    z: number;\r\n    /**\r\n     * \r\n     * @param x If not supplied, defaults to 0\r\n     * @param y If not supplied, defaults to 0\r\n     * @param z If not supplied, defaults to 0\r\n     */\r\n    constructor(x?: number, y?: number, z?: number) {\r\n        super(x ?? 0, y ?? 0);\r\n        this.z = z ?? 0;\r\n    }\r\n    \r\n    static zero: Vector3 = new Vector3(0, 0, 0);\r\n    static forward: Vector3 = new Vector3(0, 0, -1);\r\n    static backward: Vector3 = new Vector3(0, 0, 1);\r\n    static up: Vector3 = new Vector3(0, 1, 0);\r\n    static down: Vector3 = new Vector3(0, -1, 0);\r\n    static left: Vector3 = new Vector3(-1, 0, 0);\r\n    static right: Vector3 = new Vector3(1, 0, 0);\r\n\r\n    /**\r\n     *\r\n     * Short explanation: same as vector2 magnitude, but with 3 components:\r\n     * \r\n     * |v| = x+ y + z\r\n     * \r\n     * Long explanation:\r\n     * \r\n     *                          TOP-VIEW                         SIDE-VIEW\r\n     *                              /|                               /|   \r\n     *                             / |                              / |   \r\n     *                            /  |                             /  |   \r\n     *       \"projection\" of z   /   | z                      |v| /   | y \r\n     *                          /    |                           /    | \r\n     *                         /_____|                          /_____|\r\n     *                            x                         \"projection\" of z\r\n     *\r\n     *\r\n     *    (\"projection\" of z)  = x + z\r\n     *\r\n     *      |v| = (\"projection\" of z) + y\r\n     *      |v| = x+ y + z\r\n     * \r\n     * \r\n     * \r\n     * \r\n     * \r\n     * @param v The Vector\r\n     * @returns The length(magnitude) of the vector\r\n     */\r\n    static magnitude(v: Vector3): number {\r\n        return Math.sqrt((v.x * v.x) + (v.y * v.y) + (v.z * v.z));\r\n    }\r\n    /**\r\n     * Compute the unit vector for a given vector.\r\n     * \r\n     * @param v The vector\r\n     * @returns A new unit vector\r\n     */\r\n    static normalize(v: Vector3): Vector3 {\r\n        let len = Vector3.magnitude(v);\r\n        if (len > 0) {\r\n            return Vector3.divide(v, len);\r\n        } else {\r\n            return new Vector3(0, 0, 0);\r\n        }\r\n    }\r\n    /**\r\n     * Simple vector addition. \r\n     * Just add each component of both vectors together.\r\n     * \r\n     * @param a First vector\r\n     * @param b Second Vector\r\n     * @returns Result vector from a + b\r\n     */\r\n    static add(a: Vector3, b: Vector3): Vector3 {\r\n        return new Vector3(\r\n            a.x + b.x,\r\n            a.y + b.y,\r\n            a.z + b.z);\r\n    }\r\n    /**\r\n     * Simple vector subtraction. \r\n     * Just subtract each component of both vectors together.\r\n     * \r\n     * @param a First vector\r\n     * @param b Second Vector\r\n     * @returns Result vector from a - b\r\n     */\r\n    static subtract(a: Vector3, b: Vector3): Vector3 {\r\n        return new Vector3(\r\n            a.x - b.x,\r\n            a.y - b.y,\r\n            a.z - b.z);\r\n    }\r\n    /**\r\n     * Multiply each vector component by a scalar factor.\r\n     * Can be thought of scaling a vector by a factor.\r\n     * \r\n     * @param v The vector\r\n     * @param scalar The scaling factor\r\n     * @returns New scaled vector\r\n     */\r\n    static multiply(v: Vector3, scalar: number): Vector3 {\r\n        return new Vector3(\r\n            v.x * scalar,\r\n            v.y * scalar,\r\n            v.z * scalar\r\n        );\r\n    }\r\n    /**\r\n     * Divide each vector component by a scalar factor.\r\n     * Can be thought of \"inverse\" of scaling a vector by a factor.\r\n     * \r\n     * @param v The vector\r\n     * @param scalar The \"inverse\" scaling factor\r\n     * @returns New scaled vector\r\n     */\r\n    static divide(v: Vector3, scalar: number): Vector3 {\r\n        if (scalar !== 0) {\r\n            return new Vector3(\r\n                v.x / scalar,\r\n                v.y / scalar,\r\n                v.z / scalar\r\n            );\r\n        } else {\r\n            console.error(\"Can't divide by zero, Vector3 was not divided!\");\r\n            return v;\r\n        }\r\n    }\r\n    /**\r\n     * Can be thought of as \"how aligned are two vectors\".\r\n     * \r\n     * Or like a projection(or the sadow) of a vector into another\r\n     * \r\n     * of the triangle formed by the x and y components.\r\n     * \r\n     *               \r\n     *               \r\n     *              Y|     B\r\n     *               |     /|\r\n     *               |    / | \r\n     *               |   /  |\r\n     *               |  /   |\r\n     *               | /    |\r\n     *               |/     |\r\n     *               |------>A.B---------->A\r\n     *               |----------------------->\t\r\n     *                                        X\r\n     * \r\n     * PS.: compare 2D and 3D vector magnitude comments to clarify how the third component(z) affects the calculation\r\n     * \r\n     * \r\n     * @param a Some vector\r\n     * @param b Some other vector\r\n     * @returns The result of the dot product\r\n     */\r\n    static dotProduct(a: Vector3, b: Vector3): number {\r\n        return (a.x * b.x) + (a.y * b.y) + (a.z * b.z);\r\n    }\r\n    /**\r\n     * Computes the cross product between two vectors.\r\n     * The result of a cross product is a third vector which is orthogonal(90) to A and B\r\n     * It can be thought of computing the normal vector to a plane described by A and B\r\n     * \r\n     * @param a Some vector\r\n     * @param b Some other vector\r\n     * @returns A new orthogonal vector to A and B\r\n     */\r\n    static vectorCrossProduct(a: Vector3, b: Vector3): Vector3 {\r\n        return new Vector3(\r\n            (a.y * b.z) - (a.z * b.y),\r\n            (a.z * b.x) - (a.x * b.z),\r\n            (a.x * b.y) - (a.y * b.x)\r\n        );\r\n    }\r\n    static interpolate(a: Vector3, b: Vector3, step: number): Vector3 {\r\n        let x = lerp(a.x, b.x, step);\r\n        let y = lerp(a.y, b.y, step);\r\n        let z = lerp(a.z, b.z, step);\r\n\r\n        return new Vector3(x, y, z);\r\n    }\r\n}\r\n\r\nexport class Vector4 extends Vector3 {\r\n    w: number;\r\n    /**\r\n     * \r\n     * @param x If not supplied, defaults to 0\r\n     * @param y If not supplied, defaults to 0\r\n     * @param z If not supplied, defaults to 0\r\n     * @param w If not supplied, defaults to 1\r\n     */\r\n    constructor(x?: number, y?: number, z?: number, w?: number) {\r\n        super(x ?? 0, y ?? 0, z ?? 0);\r\n        this.w = w ?? 1;\r\n    }\r\n    static forward: Vector4 = new Vector4(0, 0, -1, 1);\r\n    static backward: Vector4 = new Vector4(0, 0, 1, 1);\r\n    static up: Vector4 = new Vector4(0, 1, 0, 1);\r\n    static down: Vector4 = new Vector4(0, -1, 0, 1);\r\n    static left: Vector4 = new Vector4(-1, 0, 0, 1);\r\n    static right: Vector4 = new Vector4(1, 0, 0, 1);\r\n}","import { Quaternion } from \"./quaternion\";\r\nimport { Vector3, Vector4 } from \"./vector\"\r\n\r\n//remember webGL is right-handed\r\n/**\r\n * This is a 4 ROWS(horizontal) by 4 COLUMNS matrix\r\n * \r\n * | r0c0  r0c1  r0c2  r0c3 | // row 0\r\n * | r1c0  r1c1  r1c2  r1c3 | // row 1\r\n * | r2c0  r2c1  r2c2  r2c3 | // row 2\r\n * | r3c0  r3c1  r3c2  r3c3 | // row 3\r\n * \r\n * BUT, the way WEBGL expects matrix data is as a single array, and \"column major\".\r\n * \r\n * So our matrix will be something like:\r\n * | r0c0  r1c0  r2c0  r3c0 | // col 0\r\n * | r0c1  r1c1  r2c1  r3c1 | // col 1\r\n * | r0c2  r1c2  r2c2  r3c2 | // col 2\r\n * | r0c3  r1c3  r2c3  r3c3 | // col 3\r\n * \r\n * or, in a single array: \r\n * \r\n * [ r0c0,  r1c0,  r2c0,  r3c0, r0c1,  r1c1,  r2c1,  r3c1,  r0c2,  r1c2,  r2c2,  r3c2, r0c3  r1c3  r2c3  r3c3 ]\r\n */\r\nexport class Matrix4 {\r\n    elements: number[]\r\n\r\n    constructor(r0c0?: number, r0c1?: number, r0c2?: number, r0c3?: number,\r\n        r1c0?: number, r1c1?: number, r1c2?: number, r1c3?: number,\r\n        r2c0?: number, r2c1?: number, r2c2?: number, r2c3?: number,\r\n        r3c0?: number, r3c1?: number, r3c2?: number, r3c3?: number) {\r\n        this.elements = [\r\n            r0c0 ?? 0, r0c1 ?? 0, r0c2 ?? 0, r0c3 ?? 0, // thats actually a column, not a row, but i call it row!\r\n            r1c0 ?? 0, r1c1 ?? 0, r1c2 ?? 0, r1c3 ?? 0,\r\n            r2c0 ?? 0, r2c1 ?? 0, r2c2 ?? 0, r2c3 ?? 0,\r\n            r3c0 ?? 0, r3c1 ?? 0, r3c2 ?? 0, r3c3 ?? 0,\r\n        ];\r\n    }\r\n    /**\r\n     * Get elements from the matrix at a given position.\r\n     * @param row Rows are zero based!\r\n     * @param col Columns are zero based!\r\n     * @returns The value at that position\r\n     */\r\n    getElementAt(row: number, col: number): number {\r\n        return this.elements[(col * 4) + row];\r\n    }\r\n    /**\r\n     * Set the value at a given position in the matrix\r\n     * @param row Rows are zero based!\r\n     * @param col Columns are zero based!\r\n     * @param value The value to be set\r\n     */\r\n    setElementAt(row: number, col: number, value: number): void {\r\n        this.elements[(col * 4) + row] = value;\r\n    }\r\n    flatten(): number[] {\r\n        return this.elements;\r\n    }\r\n\r\n    /**\r\n     * Identity matrix is the equivalent of the number \"1\" in matrices.\r\n     * In the sense that if we multiply any matrix 'M'by an Identity matrix 'I', the result will be 'M'.\r\n     * \r\n     * M * I = M\r\n     * \r\n     * @returns The identity matrix\r\n     */\r\n    static makeIdentity(): Matrix4 {\r\n        return new Matrix4(\r\n            1, 0, 0, 0,\r\n            0, 1, 0, 0,\r\n            0, 0, 1, 0,\r\n            0, 0, 0, 1);\r\n    }\r\n    /**\r\n     * Make a scale matrix\r\n     * @param x scale in x\r\n     * @param y scale in y\r\n     * @param z scale in z\r\n     * @returns The scale matrix\r\n     */\r\n    static makeScale(x: number, y: number, z: number): Matrix4 {\r\n        return new Matrix4(\r\n            x, 0, 0, 0,\r\n            0, y, 0, 0,\r\n            0, 0, z, 0,\r\n            0, 0, 0, 1\r\n        );\r\n    }\r\n    /**\r\n     * Make a translation matrix\r\n     * @param x translation in x\r\n     * @param y translation in y\r\n     * @param z translation in z\r\n     * @returns The translation matrix\r\n     */\r\n    static makeTranslation(x: number, y: number, z: number): Matrix4 {\r\n        return new Matrix4(\r\n            1, 0, 0, 0,\r\n            0, 1, 0, 0,\r\n            0, 0, 1, 0,\r\n            x, y, z, 1\r\n        );\r\n    }\r\n    /**\r\n     * Make a rotation in X axis matrix\r\n     * @param angleInRadians rotation angle in radians!\r\n     * @returns The rotation matrix\r\n     */\r\n    static makeXRotation(angleInRadians: number): Matrix4 {\r\n        let sine = Math.sin(angleInRadians);\r\n        let cosine = Math.cos(angleInRadians);\r\n\r\n        return new Matrix4(\r\n            1, 0, 0, 0,\r\n            0, cosine, sine, 0,\r\n            0, -sine, cosine, 0,\r\n            0, 0, 0, 1\r\n        );\r\n    }\r\n    /**\r\n     * Make a rotation in Y axis matrix\r\n     * @param angleInRadians rotation angle in radians!\r\n     * @returns The rotation matrix\r\n     */\r\n    static makeYRotation(angleInRadians: number): Matrix4 {\r\n        let sine = Math.sin(angleInRadians);\r\n        let cosine = Math.cos(angleInRadians);\r\n\r\n        return new Matrix4(\r\n            cosine, 0, -sine, 0,\r\n            0, 1, 0, 0,\r\n            sine, 0, cosine, 0,\r\n            0, 0, 0, 1\r\n        );\r\n    }\r\n    /**\r\n     * Make a rotation in Z axis matrix\r\n     * @param angleInRadians rotation angle in radians!\r\n     * @returns The rotation matrix\r\n     */\r\n    static makeZRotation(angleInRadians: number): Matrix4 {\r\n        let sine = Math.sin(angleInRadians);\r\n        let cosine = Math.cos(angleInRadians);\r\n\r\n        return new Matrix4(\r\n            cosine, sine, 0, 0,\r\n            -sine, cosine, 0, 0,\r\n            0, 0, 1, 0,\r\n            0, 0, 0, 1\r\n        );\r\n    }\r\n    /**\r\n     * Make a perspective matrix\r\n     * @param fovInRadians Field of view angle, in radians!\r\n     * @param aspectRatio width/height ratio\r\n     * @param zNear The near z coordinate\r\n     * @param zFar The far z coordinate\r\n     * @returns \r\n     */\r\n    static makePerspective(fovInRadians: number, aspectRatio: number, zNear: number, zFar: number): Matrix4 {\r\n        // let f = Math.tan(fovInRadians / 2);\r\n\r\n        // return new Matrix4(\r\n        //     1 / (aspectRatio * f), 0, 0, 0,\r\n        //     0, 1 / f, 0, 0,\r\n        //     0, 0, zFar / (zFar - zNear), -(zFar * zNear) / (zFar - zNear),\r\n        //     0, 0, 0, 1);\r\n        let f = Math.tan(Math.PI * 0.5 - 0.5 * fovInRadians);\r\n        let rangeInv = 1.0 / (zNear - zFar);\r\n\r\n        return new Matrix4(\r\n            f / aspectRatio, 0, 0, 0,\r\n            0, f, 0, 0,\r\n            0, 0, (zNear + zFar) * rangeInv, -1,\r\n            0, 0, (zNear * zFar * rangeInv * 2), 0);\r\n\r\n    }\r\n\r\n    static makeLookAtMatrix(position: Vector3, target: Vector3, up: Vector3): Matrix4 {\r\n        let zAxis = Vector3.normalize(Vector3.subtract(position, target));\r\n        let xAxis = Vector3.normalize(Vector3.vectorCrossProduct(up, zAxis));\r\n        var yAxis = Vector3.normalize(Vector3.vectorCrossProduct(zAxis, xAxis));\r\n\r\n        return new Matrix4(\r\n            xAxis.x, xAxis.y, xAxis.z, 0,\r\n            yAxis.x, yAxis.y, yAxis.z, 0,\r\n            zAxis.x, zAxis.y, zAxis.z, 0,\r\n            position.x, position.y, position.z, 1\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Make a view(camera) matrix\r\n     * @param eye The eye/camera position\r\n     * @param target The \"look at target\" (position + direction)\r\n     * @param up The UP vector\r\n     * @returns The view(camera) matrix\r\n     */\r\n    static makeViewMatrix(eye: Vector3, target: Vector3, up: Vector3): Matrix4 {\r\n        //TODO: maybe use look at matrix here\r\n        let forwardZ = Vector3.normalize(Vector3.subtract(eye, target));\r\n        let rightX = Vector3.normalize(Vector3.vectorCrossProduct(up, forwardZ));\r\n        let upY = Vector3.vectorCrossProduct(forwardZ, rightX);\r\n        //this matrix is result of multiplying a translate with rotation(inverse of) matrix:\r\n\r\n        // | 1  0  0  eyeX |     | x.x  y.x  z.x  0 |(Inverse)\r\n        // | 0  1  0  eyeY |  *  | x.y  y.y  z.y  0 |\r\n        // | 0  0  1  eyeZ |     | x.z  y.z  z.z  0 |\r\n        // | 0  0  0   1   |     |  0    0    0   1 |\r\n\r\n        //since it is an orthogonal matrix, to compute the inverse we just transpose:\r\n        // | 1  0  0  eyeX |     | x.x  x.y  x.z  0 |(Inverse)\r\n        // | 0  1  0  eyeY |  *  | y.x  y.y  y.z  0 |\r\n        // | 0  0  1  eyeZ |     | z.x  z.y  z.z  0 |\r\n        // | 0  0  0   1   |     |  0    0    0   1 |\r\n\r\n        // | x.x  x.y  x.z  -dot(x, eye) |\r\n        // | y.x  y.y  y.z  -dot(y, eye) |\r\n        // | z.x  y.z  z.z  -dot(z, eye) |\r\n        // |  0    0    0        1       |\r\n\r\n        // return new Matrix4(\r\n        //     rightX.x,     rightX.y,     rightX.z,   -Vector3.dotProduct(rightX, eye),\r\n        //     upY.x,           upY.y,        upY.z,      -Vector3.dotProduct(upY, eye),\r\n        //     forwardZ.x, forwardZ.y,   forwardZ.z, -Vector3.dotProduct(forwardZ, eye),\r\n        //     0,                   0,            0,                                  1\r\n        // );\r\n        return new Matrix4(\r\n            rightX.x, upY.x, forwardZ.x, 0,\r\n            rightX.y, upY.y, forwardZ.y, 0,\r\n            rightX.z, upY.z, forwardZ.z, 0,\r\n            -Vector3.dotProduct(rightX, eye), -Vector3.dotProduct(upY, eye), -Vector3.dotProduct(forwardZ, eye), 1\r\n        );\r\n\r\n\r\n    }\r\n    /**\r\n     * Multiply a Vector by a Matrix.\r\n     * Can be thought of as \"applying a transformation\" to a vector\r\n     * @param m The matrix\r\n     * @param v The vector\r\n     * @returns Transformed vector\r\n     */\r\n    static multiplyMatrix4ByVector4(m: Matrix4, v: Vector4): Vector4 {\r\n        return new Vector4(\r\n            // v.x * m.getElementAt(0, 0) + v.y * m.getElementAt(1, 0) + v.z * m.getElementAt(2, 0) + v.w * m.getElementAt(3, 0),\r\n            // v.x * m.getElementAt(0, 1) + v.y * m.getElementAt(1, 1) + v.z * m.getElementAt(2, 1) + v.w * m.getElementAt(3, 1),\r\n            // v.x * m.getElementAt(0, 2) + v.y * m.getElementAt(1, 2) + v.z * m.getElementAt(2, 2) + v.w * m.getElementAt(3, 2),\r\n            // v.x * m.getElementAt(0, 3) + v.y * m.getElementAt(1, 3) + v.z * m.getElementAt(2, 3) + v.w * m.getElementAt(3, 3),\r\n            v.x * m.getElementAt(0, 0) + v.y * m.getElementAt(0, 1) + v.z * m.getElementAt(0, 2) + v.w * m.getElementAt(0, 3),\r\n            v.x * m.getElementAt(1, 0) + v.y * m.getElementAt(1, 1) + v.z * m.getElementAt(1, 2) + v.w * m.getElementAt(1, 3),\r\n            v.x * m.getElementAt(2, 0) + v.y * m.getElementAt(2, 1) + v.z * m.getElementAt(2, 2) + v.w * m.getElementAt(2, 3),\r\n            v.x * m.getElementAt(3, 0) + v.y * m.getElementAt(3, 1) + v.z * m.getElementAt(3, 2) + v.w * m.getElementAt(3, 3),\r\n        );\r\n    }\r\n    /**\r\n     * Multiply two matrices.\r\n     * Can be thought of as \"accumulating matrices transformations\"\r\n     * @param a Some matrix\r\n     * @param b Some other matrix\r\n     * @returns Multiplied matrix\r\n     */\r\n    static multiplyMatrices4(a: Matrix4, b: Matrix4): Matrix4 {\r\n        let multiplied = new Matrix4();\r\n        for (let i = 0; i < 4; i++) {\r\n            for (let j = 0; j < 4; j++) {\r\n                let value = (b.getElementAt(i, 0) * a.getElementAt(0, j)) +\r\n                    (b.getElementAt(i, 1) * a.getElementAt(1, j)) +\r\n                    (b.getElementAt(i, 2) * a.getElementAt(2, j)) +\r\n                    (b.getElementAt(i, 3) * a.getElementAt(3, j));\r\n                multiplied.setElementAt(i, j, value);\r\n            }\r\n        }\r\n        return multiplied;\r\n    }\r\n    /**\r\n     * Transpose a matrix. \r\n     * Rows become columns and vice versa\r\n     * @param m the matrix\r\n     * @returns transposed matrix\r\n     */\r\n    static transpose(m: Matrix4): Matrix4 {\r\n        let transposed = new Matrix4();\r\n        for (let i = 0; i < 4; i++) {\r\n            for (let j = 0; j < 4; j++) {\r\n                transposed.setElementAt(i, j, m.getElementAt(j, i));\r\n            }\r\n        }\r\n        return transposed;\r\n    }\r\n\r\n    static copy(m: Matrix4): Matrix4 {\r\n        let copied = new Matrix4();\r\n        for (let i = 0; i < 4; i++) {\r\n            for (let j = 0; j < 4; j++) {\r\n                copied.setElementAt(i, j, m.getElementAt(i, j));\r\n            }\r\n        }\r\n        return copied;\r\n    }\r\n\r\n    static inverse(m: Matrix4): Matrix4 {\r\n        //matrix inverse from https://webglfundamentals.org/\r\n        //this.elements[(col * 4) + row];\r\n        let m00 = m.getElementAt(0, 0);\r\n        let m01 = m.getElementAt(1, 0);\r\n        let m02 = m.getElementAt(2, 0);\r\n        let m03 = m.getElementAt(3, 0);\r\n        let m10 = m.getElementAt(0, 1);\r\n        let m11 = m.getElementAt(1, 1);\r\n        let m12 = m.getElementAt(2, 1);\r\n        let m13 = m.getElementAt(3, 1);\r\n        let m20 = m.getElementAt(0, 2);\r\n        let m21 = m.getElementAt(1, 2);\r\n        let m22 = m.getElementAt(2, 2);\r\n        let m23 = m.getElementAt(3, 2);\r\n        let m30 = m.getElementAt(0, 3);\r\n        let m31 = m.getElementAt(1, 3);\r\n        let m32 = m.getElementAt(2, 3);\r\n        let m33 = m.getElementAt(3, 3);\r\n\r\n        let tmp_0 = m22 * m33;\r\n        let tmp_1 = m32 * m23;\r\n        let tmp_2 = m12 * m33;\r\n        let tmp_3 = m32 * m13;\r\n        let tmp_4 = m12 * m23;\r\n        let tmp_5 = m22 * m13;\r\n        let tmp_6 = m02 * m33;\r\n        let tmp_7 = m32 * m03;\r\n        let tmp_8 = m02 * m23;\r\n        let tmp_9 = m22 * m03;\r\n        let tmp_10 = m02 * m13;\r\n        let tmp_11 = m12 * m03;\r\n        let tmp_12 = m20 * m31;\r\n        let tmp_13 = m30 * m21;\r\n        let tmp_14 = m10 * m31;\r\n        let tmp_15 = m30 * m11;\r\n        let tmp_16 = m10 * m21;\r\n        let tmp_17 = m20 * m11;\r\n        let tmp_18 = m00 * m31;\r\n        let tmp_19 = m30 * m01;\r\n        let tmp_20 = m00 * m21;\r\n        let tmp_21 = m20 * m01;\r\n        let tmp_22 = m00 * m11;\r\n        let tmp_23 = m10 * m01;\r\n\r\n        var t0 = (tmp_0 * m11 + tmp_3 * m21 + tmp_4 * m31) -\r\n            (tmp_1 * m11 + tmp_2 * m21 + tmp_5 * m31);\r\n        var t1 = (tmp_1 * m01 + tmp_6 * m21 + tmp_9 * m31) -\r\n            (tmp_0 * m01 + tmp_7 * m21 + tmp_8 * m31);\r\n        var t2 = (tmp_2 * m01 + tmp_7 * m11 + tmp_10 * m31) -\r\n            (tmp_3 * m01 + tmp_6 * m11 + tmp_11 * m31);\r\n        var t3 = (tmp_5 * m01 + tmp_8 * m11 + tmp_11 * m21) -\r\n            (tmp_4 * m01 + tmp_9 * m11 + tmp_10 * m21);\r\n\r\n        var d = 1.0 / (m00 * t0 + m10 * t1 + m20 * t2 + m30 * t3);\r\n\r\n        return new Matrix4(\r\n            d * t0,\r\n            d * t1,\r\n            d * t2,\r\n            d * t3,\r\n            d * ((tmp_1 * m10 + tmp_2 * m20 + tmp_5 * m30) -\r\n                (tmp_0 * m10 + tmp_3 * m20 + tmp_4 * m30)),\r\n            d * ((tmp_0 * m00 + tmp_7 * m20 + tmp_8 * m30) -\r\n                (tmp_1 * m00 + tmp_6 * m20 + tmp_9 * m30)),\r\n            d * ((tmp_3 * m00 + tmp_6 * m10 + tmp_11 * m30) -\r\n                (tmp_2 * m00 + tmp_7 * m10 + tmp_10 * m30)),\r\n            d * ((tmp_4 * m00 + tmp_9 * m10 + tmp_10 * m20) -\r\n                (tmp_5 * m00 + tmp_8 * m10 + tmp_11 * m20)),\r\n            d * ((tmp_12 * m13 + tmp_15 * m23 + tmp_16 * m33) -\r\n                (tmp_13 * m13 + tmp_14 * m23 + tmp_17 * m33)),\r\n            d * ((tmp_13 * m03 + tmp_18 * m23 + tmp_21 * m33) -\r\n                (tmp_12 * m03 + tmp_19 * m23 + tmp_20 * m33)),\r\n            d * ((tmp_14 * m03 + tmp_19 * m13 + tmp_22 * m33) -\r\n                (tmp_15 * m03 + tmp_18 * m13 + tmp_23 * m33)),\r\n            d * ((tmp_17 * m03 + tmp_20 * m13 + tmp_23 * m23) -\r\n                (tmp_16 * m03 + tmp_21 * m13 + tmp_22 * m23)),\r\n            d * ((tmp_14 * m22 + tmp_17 * m32 + tmp_13 * m12) -\r\n                (tmp_16 * m32 + tmp_12 * m12 + tmp_15 * m22)),\r\n            d * ((tmp_20 * m32 + tmp_12 * m02 + tmp_19 * m22) -\r\n                (tmp_18 * m22 + tmp_21 * m32 + tmp_13 * m02)),\r\n            d * ((tmp_18 * m12 + tmp_23 * m32 + tmp_15 * m02) -\r\n                (tmp_22 * m32 + tmp_14 * m02 + tmp_19 * m12)),\r\n            d * ((tmp_22 * m22 + tmp_16 * m02 + tmp_21 * m12) -\r\n                (tmp_20 * m12 + tmp_23 * m22 + tmp_17 * m02))\r\n        );\r\n    }\r\n    static compose(translation: Vector3, scale: Vector3, quaternion: Vector4): Matrix4 {\r\n        let result = Matrix4.makeIdentity();\r\n\r\n        const x2 = quaternion.x + quaternion.x;\r\n        const y2 = quaternion.y + quaternion.y;\r\n        const z2 = quaternion.z + quaternion.z;\r\n\r\n        const xx = quaternion.x * x2;\r\n        const xy = quaternion.x * y2;\r\n        const xz = quaternion.x * z2;\r\n\r\n        const yy = quaternion.y * y2;\r\n        const yz = quaternion.y * z2;\r\n        const zz = quaternion.z * z2;\r\n\r\n        const wx = quaternion.w * x2;\r\n        const wy = quaternion.w * y2;\r\n        const wz = quaternion.w * z2;\r\n\r\n        result.elements[0] = (1 - (yy + zz)) * scale.x;\r\n        result.elements[1] = (xy + wz) * scale.x;\r\n        result.elements[2] = (xz - wy) * scale.x;\r\n        result.elements[3] = 0;\r\n\r\n        result.elements[4] = (xy - wz) * scale.y;\r\n        result.elements[5] = (1 - (xx + zz)) * scale.y;\r\n        result.elements[6] = (yz + wx) * scale.y;\r\n        result.elements[7] = 0;\r\n\r\n        result.elements[8] = (xz + wy) * scale.z;\r\n        result.elements[9] = (yz - wx) * scale.z;\r\n        result.elements[10] = (1 - (xx + yy)) * scale.z;\r\n        result.elements[11] = 0;\r\n\r\n        result.elements[12] = translation.x;\r\n        result.elements[13] = translation.y;\r\n        result.elements[14] = translation.z;\r\n        result.elements[15] = 1;\r\n\r\n        return result;\r\n    }\r\n    static decompose(m: Matrix4): [translation: Vector3, rotation: Quaternion, scale: Vector3] {\r\n        let translation = new Vector3();\r\n        let rotation = new Quaternion();\r\n        let scale = new Vector3();\r\n\r\n        let sliceX = m.elements.slice(0, 3);\r\n        let sliceY = m.elements.slice(4, 7);\r\n        let sliceZ = m.elements.slice(8, 11);\r\n\r\n        let sx = Vector3.magnitude(new Vector3(sliceX[0], sliceX[1], sliceX[2]));\r\n        const sy = Vector3.magnitude(new Vector3(sliceY[0], sliceY[1], sliceY[2]));\r\n        const sz = Vector3.magnitude(new Vector3(sliceZ[0], sliceZ[1], sliceZ[2]));\r\n\r\n        // if determinate is negative, we need to invert one scale\r\n        const det = this.determinate(m);\r\n        if (det < 0) {\r\n            sx = -sx;\r\n        }\r\n\r\n        translation.x = m.elements[12];\r\n        translation.y = m.elements[13];\r\n        translation.z = m.elements[14];\r\n\r\n        // scale the rotation part\r\n        const matrix = Matrix4.copy(m);\r\n\r\n        const invSX = 1 / sx;\r\n        const invSY = 1 / sy;\r\n        const invSZ = 1 / sz;\r\n\r\n        matrix.elements[0] *= invSX;\r\n        matrix.elements[1] *= invSX;\r\n        matrix.elements[2] *= invSX;\r\n\r\n        matrix.elements[4] *= invSY;\r\n        matrix.elements[5] *= invSY;\r\n        matrix.elements[6] *= invSY;\r\n\r\n        matrix.elements[8] *= invSZ;\r\n        matrix.elements[9] *= invSZ;\r\n        matrix.elements[10] *= invSZ;\r\n\r\n        rotation = Quaternion.fromMatrix4(matrix);\r\n\r\n        scale.x = sx;\r\n        scale.y = sy;\r\n        scale.z = sz;\r\n\r\n        return [translation, rotation, scale];\r\n    }\r\n\r\n    static determinate(m: Matrix4) {\r\n        let m00 = m.getElementAt(0, 0);\r\n        let m01 = m.getElementAt(1, 0);\r\n        let m02 = m.getElementAt(2, 0);\r\n        let m03 = m.getElementAt(3, 0);\r\n        let m10 = m.getElementAt(0, 1);\r\n        let m11 = m.getElementAt(1, 1);\r\n        let m12 = m.getElementAt(2, 1);\r\n        let m13 = m.getElementAt(3, 1);\r\n        let m20 = m.getElementAt(0, 2);\r\n        let m21 = m.getElementAt(1, 2);\r\n        let m22 = m.getElementAt(2, 2);\r\n        let m23 = m.getElementAt(3, 2);\r\n        let m30 = m.getElementAt(0, 3);\r\n        let m31 = m.getElementAt(1, 3);\r\n        let m32 = m.getElementAt(2, 3);\r\n        let m33 = m.getElementAt(3, 3);\r\n        let tmp_0 = m22 * m33;\r\n        let tmp_1 = m32 * m23;\r\n        let tmp_2 = m12 * m33;\r\n        let tmp_3 = m32 * m13;\r\n        let tmp_4 = m12 * m23;\r\n        let tmp_5 = m22 * m13;\r\n        let tmp_6 = m02 * m33;\r\n        let tmp_7 = m32 * m03;\r\n        let tmp_8 = m02 * m23;\r\n        let tmp_9 = m22 * m03;\r\n        let tmp_10 = m02 * m13;\r\n        let tmp_11 = m12 * m03;\r\n\r\n        let t0 = (tmp_0 * m11 + tmp_3 * m21 + tmp_4 * m31) -\r\n            (tmp_1 * m11 + tmp_2 * m21 + tmp_5 * m31);\r\n        let t1 = (tmp_1 * m01 + tmp_6 * m21 + tmp_9 * m31) -\r\n            (tmp_0 * m01 + tmp_7 * m21 + tmp_8 * m31);\r\n        let t2 = (tmp_2 * m01 + tmp_7 * m11 + tmp_10 * m31) -\r\n            (tmp_3 * m01 + tmp_6 * m11 + tmp_11 * m31);\r\n        let t3 = (tmp_5 * m01 + tmp_8 * m11 + tmp_11 * m21) -\r\n            (tmp_4 * m01 + tmp_9 * m11 + tmp_10 * m21);\r\n\r\n        return 1.0 / (m00 * t0 + m10 * t1 + m20 * t2 + m30 * t3);\r\n    }\r\n}","import { Matrix4 } from \"./matrix\";\r\nimport { Quaternion } from \"./quaternion\";\r\nimport { Vector3, Vector4 } from \"./vector\";\r\n\r\nexport class Transform {\r\n    position: Vector3;\r\n    rotation: Quaternion;\r\n    scale: Vector3;\r\n    private _up: Vector3;\r\n    private _right: Vector3;\r\n    private _forward: Vector3;\r\n    private shouldComputeDirections: boolean;\r\n    private worldMatrix: Matrix4;\r\n    private localMatrix: Matrix4;\r\n\r\n    get up(): Vector3 {\r\n        this.computeDirectionVectors();\r\n        return this._up;\r\n    }\r\n\r\n    get right(): Vector3 {\r\n        this.computeDirectionVectors();\r\n        return this._right;\r\n    }\r\n\r\n    get forward(): Vector3 {\r\n        this.computeDirectionVectors();\r\n        return this._forward;\r\n    }\r\n\r\n    constructor(position?: Vector3, rotation?: Quaternion, scale?: Vector3) {\r\n        this.reset(position, rotation, scale);\r\n    }\r\n\r\n    reset(position?: Vector3, rotation?: Quaternion, scale?: Vector3): void {\r\n        this.position = position ?? new Vector3();\r\n        this.rotation = rotation ?? new Quaternion();\r\n        this.scale = scale ?? new Vector3(1, 1, 1);\r\n        this._forward = Vector3.forward;\r\n        this._right = Vector3.right;\r\n        this._up = Vector3.up;\r\n        this.shouldComputeDirections = true;\r\n    }\r\n\r\n    computeDirectionVectors(): void {\r\n        if (!this.shouldComputeDirections) return;\r\n\r\n        //1. make rotation matrices\r\n        let rotationMatrix = this.rotation.toMatrix4();\r\n        //2. multiply direction vectors by the matrix\r\n        this._up = Matrix4.multiplyMatrix4ByVector4(rotationMatrix, Vector4.up) as Vector3;\r\n        this._forward = Matrix4.multiplyMatrix4ByVector4(rotationMatrix, Vector4.forward) as Vector3;\r\n        this._right = Matrix4.multiplyMatrix4ByVector4(rotationMatrix, Vector4.right) as Vector3;\r\n        this.shouldComputeDirections = false;\r\n    }\r\n\r\n    translate(translation: Vector3): void {\r\n        this.position = Vector3.add(this.position, translation);\r\n    }\r\n\r\n    rotate(angles: Vector3): void {\r\n        this.rotation.rotate(angles.x, angles.y, angles.z);\r\n        this.shouldComputeDirections = true; //direction vectors will be computed lazily when needed\r\n    }\r\n\r\n    setRotation(angles: Vector3): void {\r\n        this.rotation = new Quaternion();\r\n        this.rotation.rotate(angles.x, angles.y, angles.z);\r\n        this.shouldComputeDirections = true; //direction vectors will be computed lazily when needed\r\n    }\r\n\r\n    updateLocalMatrix(): void {\r\n        this.localMatrix = Matrix4.makeIdentity();\r\n        let translationMatrix = Matrix4.makeTranslation(this.position.x, this.position.y, this.position.z);\r\n        let rotationMatrix = this.rotation.toMatrix4();\r\n        let scaleMatrix = Matrix4.makeScale(this.scale.x, this.scale.y, this.scale.z);\r\n\r\n        this.localMatrix = Matrix4.multiplyMatrices4(translationMatrix, this.localMatrix);\r\n        this.localMatrix = Matrix4.multiplyMatrices4(rotationMatrix, this.localMatrix);\r\n        this.localMatrix = Matrix4.multiplyMatrices4(scaleMatrix, this.localMatrix);\r\n    }\r\n\r\n    updateWorldMatrix(parentMatrix?: Matrix4): void {\r\n        if (parentMatrix)\r\n            this.worldMatrix = Matrix4.multiplyMatrices4(this.localMatrix, parentMatrix);\r\n        else\r\n            this.worldMatrix = Matrix4.copy(this.localMatrix);\r\n    }\r\n\r\n    getWorldMatrix(): Matrix4 {\r\n        return this.worldMatrix;\r\n    }\r\n    \r\n    getLocalMatrix(): Matrix4 {\r\n        return this.localMatrix;\r\n    }\r\n\r\n    // lookAt(target: Vector3, up: Vector3): void {\r\n    //     let lookAtMatrix = Matrix4.makeLookAtMatrix(this.position, target, Vector3.up);\r\n    //     this.rotation = Matrix4.multiplyMatrix4ByVector4(lookAtMatrix, new Vector4(this.rotation.x, this.rotation.y, this.rotation.z)) as Vector3;\r\n    // }\r\n}","import { Transform } from \"./transform\";\r\n\r\n//TODO: Maybe refactor this into a generic type like \"Treeish<T>\"\r\nexport interface TreeNode { // originally it was going to be \"Node\", but it was taken by the DOM \"Node\"\r\n    transform: Transform;\r\n    parent: TreeNode;\r\n    children: TreeNode[];\r\n    setParent(parent: TreeNode): void;\r\n    addChild(child: TreeNode): void;\r\n    updateTransforms(): void;\r\n}\r\n\r\nexport abstract class BaseNode implements TreeNode {\r\n    transform: Transform;\r\n    parent: TreeNode;\r\n    children: TreeNode[];\r\n\r\n    constructor(transform?: Transform) {\r\n        this.transform = transform ?? new Transform();\r\n        this.children = [];\r\n    }\r\n\r\n    setParent(parent: TreeNode): void {\r\n        //remove this node from previous parent\r\n        if (this.parent) {\r\n            let index = this.parent.children.indexOf(this);\r\n            if (index >= 0) {\r\n                this.parent.children.splice(index, 1);\r\n            }\r\n        }\r\n\r\n        // Add this node as child of the new parent\r\n        if (parent) {\r\n            parent.addChild(this);\r\n        }\r\n        this.parent = parent;\r\n    }\r\n    addChild(child: TreeNode): void {\r\n        this.children.push(child);\r\n    }\r\n    updateTransforms(): void {\r\n        this.transform.updateLocalMatrix();\r\n\r\n        if (this.parent) {\r\n            let parentMatrix = this.parent.transform.getWorldMatrix();\r\n            this.transform.updateWorldMatrix(parentMatrix);\r\n        } else {\r\n            this.transform.updateWorldMatrix();\r\n        }\r\n\r\n        this.children.forEach(child => {\r\n            child.updateTransforms();\r\n        });\r\n    }\r\n}","import { Transform } from \"./transform\";\r\nimport { Camera } from \"./camera\";\r\nimport { BaseNode } from \"./node\";\r\nimport { Renderer } from \"./renderer\";\r\n\r\nexport abstract class Model extends BaseNode {\r\n    renderer: Renderer;\r\n\r\n    constructor(renderer: Renderer, transform?: Transform) {\r\n        super(transform);\r\n        this.renderer = renderer;\r\n    }\r\n    protected bufferData(buffer: WebGLBuffer, data: BufferSource, bufferType: number) {\r\n        let ctx = this.renderer.getContext();\r\n        ctx.bindBuffer(bufferType, buffer);\r\n        ctx.bufferData(bufferType, data, WebGLRenderingContext.STATIC_DRAW);\r\n    }\r\n    render(camera: Camera): void {\r\n        this.renderer.render(this, camera);\r\n    }\r\n    abstract update(): void;\r\n}","import { Matrix4 } from \"../Rendering/matrix\";\r\nimport { Quaternion } from \"../Rendering/quaternion\";\r\nimport { Vector3 } from \"../Rendering/vector\";\r\n\r\n//A list of JointTransform, represent the \"pose\" of the model\r\n//A JointTransform holds position and rotation relative to the parent joint(or the origin if it is the root)\r\nexport class JointTransform {\r\n    position: Vector3;\r\n    rotation: Quaternion;\r\n    scale: Vector3;\r\n    constructor(position: Vector3, rotation: Quaternion, scale: Vector3) {\r\n        this.position = position;\r\n        this.rotation = rotation;\r\n        this.scale = scale;\r\n    }\r\n\r\n    getLocalMatrix(): Matrix4 {\r\n        let localMatrix = Matrix4.makeIdentity();\r\n        let translationMatrix = Matrix4.makeTranslation(this.position.x, this.position.y, this.position.z);\r\n        let rotationMatrix = this.rotation.toMatrix4();\r\n        let scaleMatrix = Matrix4.makeScale(this.scale.x, this.scale.y, this.scale.z);\r\n\r\n        localMatrix = Matrix4.multiplyMatrices4(translationMatrix, localMatrix);\r\n        localMatrix = Matrix4.multiplyMatrices4(rotationMatrix, localMatrix);\r\n        localMatrix = Matrix4.multiplyMatrices4(scaleMatrix, localMatrix);\r\n\r\n        return localMatrix;\r\n    }\r\n\r\n    static interpolate(a: JointTransform, b: JointTransform, step: number): JointTransform {\r\n        return new JointTransform(\r\n            Vector3.interpolate(a.position, b.position, step),\r\n            Quaternion.interpolate(a.rotation, b.rotation, step),\r\n            Vector3.interpolate(a.scale, b.scale, step),\r\n        );\r\n    }\r\n}\r\n\r\n\r\n","export class Time {\r\n    static deltaTime = 0;\r\n    static time = 0;\r\n    \r\n    static computeTime(now: number) {\r\n        now *=  0.001;\r\n        this.deltaTime = now - this.time;\r\n        this.time = now;\r\n    }\r\n}\r\n","import { Matrix4 } from \"../Rendering/matrix\";\r\nimport { HumbleAnimation } from \"./animation\";\r\nimport { Joint } from \"./joint\";\r\nimport { JointTransform } from \"./JointTransform\";\r\nimport { HumbleKeyframe, Pose } from \"./keyframe\";\r\nimport { AnimatedModel } from \"./animatedModel\";\r\nimport { Time } from \"../Etc/time\";\r\n\r\nexport class Animator {\r\n    animation: HumbleAnimation;\r\n    currentTime: number;\r\n    model: AnimatedModel;\r\n    constructor(model: AnimatedModel) {\r\n        this.model = model;\r\n    }\r\n\r\n    //set, or reset an animation\r\n    doAnimation(animation: HumbleAnimation): void {\r\n        this.currentTime = 0;\r\n        this.animation = animation;\r\n    }\r\n\r\n    update(): void {\r\n        if (this.animation) {\r\n            this.increaseAnimationTime(Time.deltaTime);\r\n            let currentPose = this.computeCurrentAnimationPose();\r\n            this.applyPoseToJoints(currentPose, this.model.rootJoint, this.model.transform.getWorldMatrix());\r\n        } else {\r\n            this.applyPoseToJoints(null, this.model.rootJoint, this.model.transform.getWorldMatrix());\r\n        }\r\n    }\r\n\r\n    //increase time and, loop around when it ends\r\n    increaseAnimationTime(deltaTime: number): void {\r\n        this.currentTime += deltaTime;\r\n        if (this.currentTime > this.animation.lengthInSeconds) {\r\n            this.currentTime %= this.animation.lengthInSeconds;\r\n        }\r\n    }\r\n\r\n    computeCurrentAnimationPose(): Pose {\r\n        let [previousFrame, nextFrame] = this.getPreviousAndNextFrames();\r\n        let step = this.calculateProgression(previousFrame, nextFrame);\r\n        return this.interpolatePoses(previousFrame, nextFrame, step);\r\n    }\r\n\r\n    applyPoseToJoints(currentPose: Pose, joint: Joint, parentMatrix: Matrix4): void {\r\n        //TODO: comeback here some day!\r\n        if (currentPose) {\r\n            let currentTransform = currentPose[joint.name];\r\n            let currentMatrix = Matrix4.multiplyMatrices4(currentTransform.getLocalMatrix(), parentMatrix);\r\n\r\n            joint.children.forEach(child => {\r\n                this.applyPoseToJoints(currentPose, child as Joint, currentMatrix);\r\n            });\r\n\r\n            joint.animatedMatrix = Matrix4.multiplyMatrices4(joint.inverseBindMatrix, currentMatrix);\r\n        } else {\r\n            let currentMatrix = Matrix4.multiplyMatrices4(joint.transform.getLocalMatrix(), parentMatrix);\r\n            joint.children.forEach(child => {\r\n                this.applyPoseToJoints(null, child as Joint, currentMatrix);\r\n            });\r\n            joint.animatedMatrix = Matrix4.multiplyMatrices4(joint.inverseBindMatrix, currentMatrix);\r\n        }\r\n    }\r\n\r\n    getPreviousAndNextFrames(): [HumbleKeyframe, HumbleKeyframe] {\r\n        let allKeyFrames = this.animation.keyframes;\r\n        let previous = allKeyFrames[0];\r\n        let next = allKeyFrames[0];\r\n\r\n        for (let i = 1; i < allKeyFrames.length; i++) {\r\n            next = allKeyFrames[i];\r\n            if (next.timestamp > this.currentTime) {\r\n                break;\r\n            }\r\n            previous = allKeyFrames[i];\r\n        }\r\n\r\n        return [previous, next];\r\n    }\r\n\r\n    calculateProgression(previousFrame: HumbleKeyframe, nextFrame: HumbleKeyframe) {\r\n        let totalTime = nextFrame.timestamp - previousFrame.timestamp;\r\n        let currentTime = this.currentTime - previousFrame.timestamp\r\n\r\n        return currentTime / totalTime;\r\n    }\r\n\r\n    interpolatePoses(previousFrame: HumbleKeyframe, nextFrame: HumbleKeyframe, step: number) {\r\n        let currentPose: Pose = {} as Pose;\r\n        //foreach joint transform, interpolate between previous and next keyframe, then return a new interpolated \"Pose\"\r\n        for (const key in previousFrame.pose) {\r\n            currentPose[key] = JointTransform.interpolate(previousFrame.pose[key], nextFrame.pose[key], step);\r\n        }\r\n        return currentPose;\r\n    }\r\n}\r\n\r\n","import { Model } from \"../Rendering/model\";\r\nimport { Renderer } from \"../Rendering/renderer\";\r\nimport { HumbleAnimation } from \"./animation\";\r\nimport { Animator } from \"./animator\";\r\nimport { Joint } from \"./joint\";\r\n\r\nexport class AnimatedModel extends Model {\r\n    //buffers... maybe make all of those into a dictionary of <attrLocations, buffers> \r\n    positions: WebGLBuffer;\r\n    normals: WebGLBuffer;\r\n    textureCoords: WebGLBuffer;\r\n    indices: WebGLBuffer;\r\n    joints: WebGLBuffer;\r\n    weights: WebGLBuffer;\r\n    indexCount: number;\r\n    texture: WebGLTexture;\r\n\r\n    //skin data\r\n    boneTexture: WebGLTexture\r\n    rootJoint: Joint\r\n    jointCount: number;\r\n\r\n    animator: Animator;\r\n\r\n    constructor(positions: Float32Array, normals: Float32Array, textureCoords: Float32Array,\r\n        indices: Uint16Array, joints: Uint8Array, weights: Float32Array, rootJoint: Joint, jointCount: number, renderer: Renderer) {\r\n        super(renderer);\r\n        let ctx = this.renderer.getContext();\r\n        this.positions = ctx.createBuffer();\r\n        this.normals = ctx.createBuffer();\r\n        this.textureCoords = ctx.createBuffer();\r\n        this.indices = ctx.createBuffer();\r\n        this.joints = ctx.createBuffer();\r\n        this.weights = ctx.createBuffer();\r\n        this.indexCount = indices.length;\r\n\r\n        this.bufferData(this.indices, indices, WebGLRenderingContext.ELEMENT_ARRAY_BUFFER);\r\n        this.bufferData(this.positions, positions, WebGLRenderingContext.ARRAY_BUFFER);\r\n        this.bufferData(this.normals, normals, WebGLRenderingContext.ARRAY_BUFFER);\r\n        this.bufferData(this.textureCoords, textureCoords, WebGLRenderingContext.ARRAY_BUFFER);\r\n        this.bufferData(this.joints, joints, WebGLRenderingContext.ARRAY_BUFFER);\r\n        this.bufferData(this.weights, weights, WebGLRenderingContext.ARRAY_BUFFER);\r\n\r\n        //img-like texture\r\n        //this.texture = texture ?? null;\r\n        this.rootJoint = rootJoint ?? null;\r\n        this.jointCount = jointCount ?? 0;\r\n\r\n        //data-like texture\r\n        this.boneTexture = ctx.createTexture();\r\n        ctx.bindTexture(WebGLRenderingContext.TEXTURE_2D, this.boneTexture);\r\n        ctx.texParameteri(WebGLRenderingContext.TEXTURE_2D, WebGLRenderingContext.TEXTURE_MIN_FILTER, WebGLRenderingContext.NEAREST);\r\n        ctx.texParameteri(WebGLRenderingContext.TEXTURE_2D, WebGLRenderingContext.TEXTURE_MAG_FILTER, WebGLRenderingContext.NEAREST);\r\n        ctx.texParameteri(WebGLRenderingContext.TEXTURE_2D, WebGLRenderingContext.TEXTURE_WRAP_S, WebGLRenderingContext.CLAMP_TO_EDGE);\r\n        ctx.texParameteri(WebGLRenderingContext.TEXTURE_2D, WebGLRenderingContext.TEXTURE_WRAP_T, WebGLRenderingContext.CLAMP_TO_EDGE);\r\n\r\n        rootJoint.updateTransforms();\r\n        this.animator = new Animator(this);\r\n    }\r\n\r\n    doAnimation(animation: HumbleAnimation) {\r\n        this.animator.doAnimation(animation);\r\n    }\r\n\r\n    update(): void {\r\n\r\n        this.animator.update();\r\n\r\n        let arr = new Float32Array(this.jointCount * 16);\r\n        flattenJointMatrices(this.rootJoint);\r\n\r\n        let ctx = this.renderer.getContext();\r\n        ctx.bindTexture(ctx.TEXTURE_2D, this.boneTexture);\r\n\r\n        ctx.texImage2D(\r\n            ctx.TEXTURE_2D, 0, ctx.RGBA, 4,\r\n            this.jointCount, 0, ctx.RGBA, ctx.FLOAT, arr\r\n        );\r\n\r\n        function flattenJointMatrices(joint: Joint) {\r\n            let offset = joint.id * 16;\r\n\r\n            arr.set(joint.animatedMatrix.flatten(), offset);\r\n            if (joint.children) {\r\n                joint.children.forEach(child => {\r\n                    flattenJointMatrices(child as Joint);\r\n                });\r\n            }\r\n        }\r\n    }\r\n}","import { Camera } from \"./camera\";\r\nimport { Model } from \"./model\";\r\n\r\nexport interface Renderer {\r\n    render(model: Model, camera: Camera): void;\r\n    getContext(): WebGLRenderingContext;\r\n}\r\n\r\nexport abstract class BaseRenderer implements Renderer {\r\n    protected program: WebGLProgram;\r\n    protected context: WebGLRenderingContext;\r\n\r\n    constructor(context: WebGLRenderingContext, program: WebGLProgram) {\r\n        this.context = context;\r\n        this.program = program;\r\n    }\r\n\r\n    abstract render(model: Model, camera: Camera): void;\r\n    \r\n    getContext(): WebGLRenderingContext {\r\n        return this.context;\r\n    }\r\n}","import { Camera } from \"../Rendering/camera\";\r\nimport { Matrix4 } from \"../Rendering/matrix\";\r\nimport { BaseRenderer } from \"../Rendering/renderer\";\r\nimport { Vector3, Vector4 } from \"../Rendering/vector\";\r\nimport { AnimatedModel } from \"./animatedModel\";\r\n\r\nexport class AnimatedRenderer extends BaseRenderer {\r\n    private positionAttributeLocation: number;\r\n    private texCoordsAttributeLocation: number;\r\n    private normalsAttributeLocation: number;\r\n    private jointsAttributeLocation: number;\r\n    private weightsAttributeLocation: number;\r\n\r\n    private worldMatrixUniformLocation: WebGLUniformLocation;\r\n    private viewMatrixUniformLocation: WebGLUniformLocation;\r\n    private projectionMatrixUniformLocation: WebGLUniformLocation;\r\n    private worldInverseTransposeMatrixLocation: WebGLUniformLocation;\r\n    private reverseLightDirectionLocation: WebGLUniformLocation;\r\n    private jointTextureLocation: WebGLUniformLocation; // data as texture\r\n    private jointCountLocation: WebGLUniformLocation;\r\n\r\n    constructor(context: WebGLRenderingContext, program: WebGLProgram) {\r\n        super(context, program);\r\n\r\n        this.positionAttributeLocation = context.getAttribLocation(program, \"a_position\");\r\n        this.texCoordsAttributeLocation = context.getAttribLocation(program, \"a_texcoord\");\r\n        this.normalsAttributeLocation = context.getAttribLocation(program, \"a_normal\");\r\n        this.jointsAttributeLocation = context.getAttribLocation(program, \"a_joints\");\r\n        this.weightsAttributeLocation = context.getAttribLocation(program, \"a_weights\");\r\n\r\n        this.worldMatrixUniformLocation = context.getUniformLocation(program, \"u_worldMatrix\");\r\n        this.viewMatrixUniformLocation = context.getUniformLocation(program, \"u_viewMatrix\");\r\n        this.projectionMatrixUniformLocation = context.getUniformLocation(program, \"u_projectionMatrix\");\r\n        this.worldInverseTransposeMatrixLocation = context.getUniformLocation(program, \"u_worldInverseTransposeMatrix\");\r\n        this.reverseLightDirectionLocation = context.getUniformLocation(program, \"u_reverseLightDirection\");\r\n\r\n        this.jointTextureLocation = context.getUniformLocation(program, \"u_jointTexture\");\r\n        this.jointCountLocation = context.getUniformLocation(program, \"u_numJoints\");\r\n    }\r\n\r\n    //TODO: move this out\r\n    loadTexture(img: HTMLImageElement): WebGLTexture {\r\n        let texture = this.context.createTexture();\r\n        this.context.bindTexture(this.context.TEXTURE_2D, texture);\r\n\r\n        // Set the parameters so we can render any size image.\r\n        this.context.texParameteri(this.context.TEXTURE_2D, this.context.TEXTURE_WRAP_S, this.context.CLAMP_TO_EDGE);\r\n        this.context.texParameteri(this.context.TEXTURE_2D, this.context.TEXTURE_WRAP_T, this.context.CLAMP_TO_EDGE);\r\n        this.context.texParameteri(this.context.TEXTURE_2D, this.context.TEXTURE_MIN_FILTER, this.context.NEAREST);\r\n        this.context.texParameteri(this.context.TEXTURE_2D, this.context.TEXTURE_MAG_FILTER, this.context.NEAREST);\r\n\r\n        // Upload the image into the texture.\r\n        this.context.texImage2D(this.context.TEXTURE_2D, 0, this.context.RGBA, this.context.RGBA, this.context.UNSIGNED_BYTE, img);\r\n        this.context.generateMipmap(this.context.TEXTURE_2D);\r\n\r\n        return texture;\r\n    }\r\n\r\n    //TODO: move this out\r\n    loadTexture2(color: Vector4) { \r\n        let texture = this.context.createTexture();\r\n        this.context.bindTexture(this.context.TEXTURE_2D, texture);\r\n\r\n        // Set the parameters so we can render any size image.\r\n        this.context.texParameteri(this.context.TEXTURE_2D, this.context.TEXTURE_WRAP_S, this.context.CLAMP_TO_EDGE);\r\n        this.context.texParameteri(this.context.TEXTURE_2D, this.context.TEXTURE_WRAP_T, this.context.CLAMP_TO_EDGE);\r\n        this.context.texParameteri(this.context.TEXTURE_2D, this.context.TEXTURE_MIN_FILTER, this.context.NEAREST);\r\n        this.context.texParameteri(this.context.TEXTURE_2D, this.context.TEXTURE_MAG_FILTER, this.context.NEAREST);\r\n\r\n        // Upload the image into the texture.\r\n        this.context.texImage2D(this.context.TEXTURE_2D, 0, this.context.RGBA, 1, 1, 0, this.context.RGBA, this.context.UNSIGNED_BYTE,\r\n            new Uint8Array([0, 0, 255, 255]));\r\n        //this.context.generateMipmap(this.context.TEXTURE_2D);\r\n\r\n        return texture;\r\n    }\r\n\r\n    //TODO: move this out\r\n    clear() {\r\n        this.context.clearColor(0.5, 0.5, 0.5, 1);\r\n        this.context.clear(this.context.COLOR_BUFFER_BIT | this.context.DEPTH_BUFFER_BIT);\r\n    }\r\n\r\n    render(model: AnimatedModel, camera: Camera): void {\r\n        let projectionMatrix = camera.getPerspectiveMatrix();\r\n        let viewMatrix = Matrix4.makeViewMatrix(\r\n            camera.transform.position,\r\n            Vector3.add(camera.transform.position, camera.transform.forward),\r\n            Vector3.up);\r\n\r\n        // Tell WebGL how to convert from clip space to pixels\r\n        this.context.viewport(0, 0, this.context.canvas.width, this.context.canvas.height);\r\n        this.context.useProgram(this.program);\r\n        this.context.enable(this.context.CULL_FACE);\r\n        this.context.enable(this.context.DEPTH_TEST);\r\n\r\n        //set uniforms\r\n        this.context.uniform1i(this.jointTextureLocation, 1);  // texture unit 1\r\n        this.context.uniform1f(this.jointCountLocation, model.jointCount);  // texture unit 1\r\n        this.context.uniformMatrix4fv(this.worldMatrixUniformLocation, false, model.transform.getWorldMatrix().flatten());\r\n        this.context.uniformMatrix4fv(this.projectionMatrixUniformLocation, false, projectionMatrix.flatten());\r\n        this.context.uniformMatrix4fv(this.viewMatrixUniformLocation, false, viewMatrix.flatten());\r\n        this.context.uniform1f(this.jointCountLocation, model.jointCount);\r\n\r\n        let worldInverse = Matrix4.inverse(model.transform.getWorldMatrix());\r\n        this.context.uniformMatrix4fv(this.worldInverseTransposeMatrixLocation, false, Matrix4.transpose(worldInverse).flatten());\r\n        //TODO: use the light from Scene object\r\n        let reverseLightDirectionVector = Vector3.normalize(new Vector3(0.5, 0.7, 1));\r\n        this.context.uniform3fv(\r\n            this.reverseLightDirectionLocation,\r\n            new Float32Array([\r\n                reverseLightDirectionVector.x,\r\n                reverseLightDirectionVector.y,\r\n                reverseLightDirectionVector.z])\r\n        );\r\n\r\n        //bind buffers\r\n        this.context.bindBuffer(this.context.ARRAY_BUFFER, model.positions);\r\n        this.context.enableVertexAttribArray(this.positionAttributeLocation);\r\n        //Tell the position attribute how to get data out of positionBuffer (ARRAY_BUFFER)\r\n        this.context.vertexAttribPointer(\r\n            this.positionAttributeLocation,\r\n            3,          // we are passing 3 components per iteration\r\n            this.context.FLOAT,   // the type of each component\r\n            false,      // should normalize?\r\n            0,          // 0 = move forward size * sizeof(type) each iteration to get the next position\r\n            0           // 0 = start at the beginning of the buffer\r\n        );\r\n\r\n        this.context.bindBuffer(this.context.ARRAY_BUFFER, model.textureCoords);\r\n        this.context.enableVertexAttribArray(this.texCoordsAttributeLocation);\r\n        this.context.vertexAttribPointer(\r\n            this.texCoordsAttributeLocation,\r\n            2,         // we are passing 2 components per iteration\r\n            this.context.FLOAT,  // the type of each component\r\n            false,     // should normalize?\r\n            0,         // 0 = move forward size * sizeof(type) each iteration to get the next position\r\n            0          // 0 = start at the beginning of the buffer\r\n        );\r\n\r\n        this.context.bindBuffer(this.context.ARRAY_BUFFER, model.normals);\r\n        this.context.enableVertexAttribArray(this.normalsAttributeLocation);\r\n        this.context.vertexAttribPointer(\r\n            this.normalsAttributeLocation,\r\n            3,         // we are passing 3 components per iteration\r\n            this.context.FLOAT,  // the type of each component\r\n            false,     // should normalize?\r\n            0,         // 0 = move forward size * sizeof(type) each iteration to get the next position\r\n            0          // 0 = start at the beginning of the buffer\r\n        );\r\n\r\n        this.context.bindBuffer(this.context.ARRAY_BUFFER, model.joints);\r\n        this.context.enableVertexAttribArray(this.jointsAttributeLocation);\r\n        this.context.vertexAttribPointer(\r\n            this.jointsAttributeLocation,\r\n            4,         // we are passing 4 components per iteration\r\n            this.context.UNSIGNED_BYTE,  // the type of each component\r\n            false,     // should normalize?\r\n            0,         // 0 = move forward size * sizeof(type) each iteration to get the next position\r\n            0          // 0 = start at the beginning of the buffer\r\n        );\r\n\r\n        this.context.bindBuffer(this.context.ARRAY_BUFFER, model.weights);\r\n        this.context.enableVertexAttribArray(this.weightsAttributeLocation);\r\n        this.context.vertexAttribPointer(\r\n            this.weightsAttributeLocation,\r\n            4,         // we are passing 4 components per iteration\r\n            this.context.FLOAT,  // the type of each component\r\n            false,     // should normalize?\r\n            0,         // 0 = move forward size * sizeof(type) each iteration to get the next position\r\n            0          // 0 = start at the beginning of the buffer\r\n        );\r\n\r\n        this.context.activeTexture(this.context.TEXTURE0);\r\n        this.context.bindTexture(this.context.TEXTURE_2D, model.texture);\r\n        this.context.activeTexture(this.context.TEXTURE1);\r\n        this.context.bindTexture(this.context.TEXTURE_2D, model.boneTexture);\r\n\r\n\r\n        this.context.drawElements(\r\n            WebGLRenderingContext.TRIANGLES,\r\n            model.indexCount,\r\n            this.context.UNSIGNED_SHORT,\r\n            0\r\n        );\r\n    }\r\n}","import { JointTransform } from \"./JointTransform\";\r\n\r\nexport class HumbleKeyframe { //The name \"Keyframe\" is taken =(\r\n    timestamp: number;\r\n    pose: Pose;\r\n    constructor(timestamp: number, pose: Pose) {\r\n        this.timestamp = timestamp;\r\n        this.pose = pose;\r\n    }\r\n}\r\n\r\nexport interface Pose {\r\n    [index: string]: JointTransform; //key is the joint \"name\", value is the joint transform\r\n}","import { AnimationSampleData, SkeletonAnimationData } from \"../File/fileLoader\";\r\nimport { Quaternion } from \"../Rendering/quaternion\";\r\nimport { Vector3, Vector4 } from \"../Rendering/vector\";\r\nimport { JointTransform } from \"./JointTransform\";\r\nimport { HumbleKeyframe, Pose } from \"./keyframe\";\r\n\r\n\r\n//this holds animation data, maybe should not be a full class since we so far have no behaviour?\r\nexport class HumbleAnimation { //name Animation was taken =(\r\n    name: string;\r\n    lengthInSeconds: number;\r\n    keyframes: HumbleKeyframe[];\r\n    constructor(name: string, keyframes: HumbleKeyframe[], lengthInSeconds: number) {\r\n        this.name = name;\r\n        this.keyframes = keyframes;\r\n        this.lengthInSeconds = lengthInSeconds;\r\n    }\r\n\r\n    //TODO: maybe this should be outside this class, maybe a converter class or something?\r\n    static fromGLTFAnimation(anim: SkeletonAnimationData): HumbleAnimation {\r\n        //OK, so i am assuming that all joints have the same exact keyframes...\r\n        // maybe it is not true and i will have to comeback here and fix it.\r\n\r\n        //also, im ignoring the interpolation method and assuming its all LINEAR interpolation, since it is the only one i have implemented so far...\r\n        let lengthInSeconds = anim.animationLength;\r\n        let name = anim.animationName;\r\n\r\n        let keyframes: HumbleKeyframe[] = [];\r\n\r\n        //build a timestamp array\r\n        let samples: AnimationSampleData[];\r\n        if (anim.jointsAnimations[0].translation.samples) {\r\n            samples = anim.jointsAnimations[0].translation.samples\r\n        } else if (anim.jointsAnimations[0].rotation.samples) {\r\n            samples = anim.jointsAnimations[0].rotation.samples\r\n        } else if (anim.jointsAnimations[0].scale.samples) {\r\n            samples = anim.jointsAnimations[0].scale.samples\r\n        }\r\n\r\n        let timestamps = samples.map((s) => {\r\n            return s.timestamp;\r\n        });\r\n\r\n        //for each timestamp, lets build a Pose (which is a dictionary of <jointName, JointTransform> )\r\n        timestamps.forEach((t, i) => {\r\n            let p: Pose = {};\r\n            anim.jointsAnimations.forEach((jointAnimation) => {\r\n                let position = new Vector3(jointAnimation.translation.samples[i].values[0], jointAnimation.translation.samples[i].values[1], jointAnimation.translation.samples[i].values[2]);\r\n                let rotation = new Quaternion(jointAnimation.rotation.samples[i].values[0], jointAnimation.rotation.samples[i].values[1], jointAnimation.rotation.samples[i].values[2], jointAnimation.rotation.samples[i].values[3]);\r\n                let scale = new Vector3(jointAnimation.scale.samples[i].values[0], jointAnimation.scale.samples[i].values[1], jointAnimation.scale.samples[i].values[2]);\r\n                p[jointAnimation.jointName] = new JointTransform(position, rotation, scale);\r\n            });\r\n            keyframes.push(new HumbleKeyframe(t, p));\r\n        });\r\n        return new HumbleAnimation(name, keyframes, lengthInSeconds);\r\n    }\r\n}","export class webglUtils {\r\n\r\n    static loadFromScript(gl: WebGLRenderingContext, shaderElem: HTMLScriptElement, shaderType: GLenum): WebGLShader {\r\n        let shader = gl.createShader(shaderType);\r\n        gl.shaderSource(shader, shaderElem.text);\r\n        gl.compileShader(shader);\r\n        if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {\r\n            console.error(\"Something went wrong when compiling a vertex shader. More info:\", gl.getShaderInfoLog(shader));\r\n            return;\r\n        }\r\n        return shader;\r\n    }\r\n\r\n    static createProgram(gl: WebGLRenderingContext, vertexShader: WebGLShader, fragmentShader: WebGLShader): WebGLProgram {\r\n        let program = gl.createProgram();\r\n        gl.attachShader(program, vertexShader);\r\n        gl.attachShader(program, fragmentShader);\r\n        gl.linkProgram(program);\r\n\r\n        if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {\r\n            console.error(\"Something went wrong when compiling a vertex shader. More info:\", gl.getShaderInfoLog(program));\r\n            gl.deleteProgram(program);\r\n            return null;\r\n        }\r\n        return program;\r\n    }\r\n}","import { Matrix4 } from \"../Rendering/matrix\";\r\nimport { BaseNode } from \"../Rendering/node\";\r\nimport { Transform } from \"../Rendering/transform\";\r\n\r\nexport class Joint extends BaseNode {\r\n    id: number;\r\n    name: string;\r\n    inverseBindMatrix: Matrix4;\r\n    animatedMatrix: Matrix4;\r\n    constructor(id: number, name: string, transform: Transform, inverseMatrix: Matrix4) {\r\n        super(transform);\r\n        this.id = id;\r\n        this.name = name;\r\n        this.inverseBindMatrix = inverseMatrix;\r\n    }\r\n}","import { Transform } from \"./transform\";\r\nimport { Matrix4 } from \"./matrix\";\r\n\r\n//TODO: this camera class can only represent a perspective camera...\r\n//      make so we can represent other types(like ortho?) of cameras...\r\n//      maybe, create specialized types extending this 'base' camera?\r\nexport class Camera {\r\n    transform: Transform;\r\n    fieldOfView: number;\r\n    aspectRatio: number;\r\n    near: number;\r\n    far: number;\r\n    private perspectiveMatrix: Matrix4;\r\n    private static activeCamera: Camera = null;\r\n    constructor(fieldOfView: number, aspectRatio: number, near: number, far: number) {\r\n        this.fieldOfView = fieldOfView;\r\n        this.aspectRatio = aspectRatio;\r\n        this.near = near;\r\n        this.far = far;\r\n        this.transform = new Transform();\r\n\r\n        if (Camera.getActiveCamera() === null) {\r\n            Camera.setActiveCamera(this);\r\n        }\r\n    }\r\n    computePerspectiveMatrix(): void {\r\n        this.perspectiveMatrix = Matrix4.makePerspective(\r\n            this.fieldOfView,\r\n            this.aspectRatio,\r\n            this.near,\r\n            this.far\r\n        );\r\n    }\r\n    getPerspectiveMatrix(): Matrix4 {\r\n        return this.perspectiveMatrix;\r\n    }\r\n    static getActiveCamera(): Camera {\r\n        return Camera.activeCamera;\r\n    }\r\n    static setActiveCamera(camera: Camera): void {\r\n        Camera.activeCamera = camera;\r\n    }\r\n}\r\n\r\n","import { AnimatedModel } from \"./Animation/animatedModel\";\r\nimport { AnimatedRenderer } from \"./Animation/animatedRenderer\";\r\nimport { HumbleAnimation } from \"./Animation/animation\";\r\nimport { degToRad } from \"./Etc/mathFunctions\";\r\nimport { webglUtils } from \"./Etc/webglUtils\";\r\nimport { FileLoader } from \"./File/fileLoader\";\r\nimport { Camera } from \"./Rendering/camera\";\r\nimport { Scene } from \"./Rendering/scene\";\r\nimport { StaticRenderer } from \"./Rendering/staticRenderer\";\r\nimport { Vector3, Vector4 } from \"./Rendering/vector\";\r\nimport { Time } from \"./Etc/time\";\r\n\r\nwindow.onload = main;\r\n\r\nlet scene: Scene;\r\nlet theModel: AnimatedModel;\r\nlet staticRenderer: StaticRenderer;\r\nlet animatedRenderer: AnimatedRenderer;\r\nlet animations: { [index: string]: HumbleAnimation } = {};\r\n\r\n// stuff related to camera and camera movement\r\nlet firsPersonCamera = {\r\n    cameraObj: null as Camera,\r\n    forwardVelocity: new Vector3(),\r\n    rightVelocity: new Vector3(),\r\n    maxXRotation: degToRad(89),\r\n    minXRotation: degToRad(-89),\r\n    currentRotationAngles: new Vector3(),\r\n    cameraSpeed: 20,\r\n    mouseSensibility: 0.1,\r\n    Move(direction: Vector3) {\r\n        let cam = this.cameraObj as Camera;\r\n        let speed = this.cameraSpeed * Time.deltaTime;\r\n        let forwardVelocity = Vector3.multiply(cam.transform.forward, -direction.z);\r\n        let rightVelocity = Vector3.multiply(cam.transform.right, direction.x);\r\n        let velocity = Vector3.multiply(Vector3.add(forwardVelocity, rightVelocity), speed);\r\n        cam.transform.translate(velocity);\r\n    },\r\n    Rotate(rotationAmount: Vector3) {\r\n        //TODO: This rotation is kinda scuffed, come back here someday\r\n        let cam = this.cameraObj as Camera;\r\n        let speed = this.mouseSensibility * Time.deltaTime;\r\n\r\n        this.currentRotationAngles.x -= speed * rotationAmount.x;\r\n        this.currentRotationAngles.y -= speed * rotationAmount.y;\r\n\r\n        if (this.currentRotationAngles.x > this.maxXRotation) this.currentRotationAngles.x = this.maxXRotation;\r\n        else if (this.currentRotationAngles.x < this.minXRotation) this.currentRotationAngles.x = this.minXRotation;\r\n\r\n        cam.transform.setRotation(this.currentRotationAngles);\r\n    }\r\n};\r\n\r\n// this is for keyboard event handling\r\n// when 'keydown' happens, we set to true\r\n// when 'keyup' happens, we set to false\r\n// in the gameloop we process input based on this flags.\r\nlet controls = {\r\n    up: false,\r\n    down: false,\r\n    left: false,\r\n    right: false\r\n}\r\n\r\n//html elements\r\nlet viewElements = {\r\n    loadingState: document.querySelector(\"#loading-state\") as HTMLInputElement,\r\n    loadedState: document.querySelector(\"#loaded-state\") as HTMLInputElement,\r\n    xRotationElement: document.querySelector(\"#x-rotation\") as HTMLInputElement,\r\n    yRotationElement: document.querySelector(\"#y-rotation\") as HTMLInputElement,\r\n    zRotationElement: document.querySelector(\"#z-rotation\") as HTMLInputElement,\r\n    animationSelect: document.querySelector(\"#select-animations\") as HTMLInputElement\r\n}\r\n\r\nfunction main(): void {\r\n    //for debugging\r\n    window.onerror = function myErrorHandler(errorMsg, url, lineNumber) {\r\n        alert(\"Error occured: \" + errorMsg);//or any message\r\n        return false;\r\n    }\r\n    showLoadingState();\r\n    setup();\r\n    loadResources().then((gltfModel) => {\r\n        //there is no texture, so...\r\n        //1-pixel-1-color-texture mockup\r\n        let texture = animatedRenderer.loadTexture2(new Vector4(0, 0, 255, 255));\r\n\r\n        //instantiate the model\r\n        theModel = new AnimatedModel(\r\n            gltfModel.positionData,\r\n            gltfModel.normalData,\r\n            gltfModel.texCoordData,\r\n            gltfModel.indicesData,\r\n            gltfModel.jointData,\r\n            gltfModel.weightData,\r\n            gltfModel.rootJoint,\r\n            gltfModel.jointCount,\r\n            animatedRenderer);\r\n        theModel.texture = texture;\r\n\r\n        //add to scene\r\n        scene.rootNodes.push(theModel);\r\n        scene.renderables.push(theModel);\r\n        setupStaticModel();\r\n\r\n        //save animations into a dictionary so we can pick in HTML\r\n        gltfModel.animations.forEach(anim => {\r\n            animations[anim.animationName] = HumbleAnimation.fromGLTFAnimation(anim);\r\n        });\r\n\r\n        buildAnimationOptions(Object.keys(animations));\r\n        createEventHandlers();\r\n        requestAnimationFrame(gameLoop);\r\n        showLoadedState();\r\n    });\r\n}\r\n\r\nfunction setup(): void {\r\n    let canvasElem: HTMLCanvasElement = document.querySelector(\"#canvas\");\r\n    let vertexShaderElemStatic: HTMLScriptElement = document.querySelector(\"#vertex-shader-3d-textured-lit\");\r\n    let fragmentShaderElemStatic: HTMLScriptElement = document.querySelector(\"#fragment-shader-3d-textured-lit\");\r\n\r\n    let vertexShaderElemAnimated: HTMLScriptElement = document.querySelector(\"#vertex-shader-3d-textured-skinned\");\r\n    let fragmentShaderElemAnimated: HTMLScriptElement = document.querySelector(\"#fragment-shader-3d-textured-skinned\");\r\n\r\n    //initialize canvas and webgl stuff\r\n    let gl = canvasElem.getContext(\"webgl\");\r\n    if (!gl) {\r\n        console.error(\"Something went wrong while creating webgl context\");\r\n        return;\r\n    }\r\n    let ext = gl.getExtension('OES_texture_float');\r\n    if (!ext) {\r\n        throw new Error(\"Could not run in your browser, sorry! More info: OES_texture_float extension missing!\");\r\n    }\r\n\r\n    let vertexShader = webglUtils.loadFromScript(gl, vertexShaderElemStatic, gl.VERTEX_SHADER);\r\n    let fragmentShader = webglUtils.loadFromScript(gl, fragmentShaderElemStatic, gl.FRAGMENT_SHADER);\r\n    let program = webglUtils.createProgram(gl, vertexShader, fragmentShader);\r\n    staticRenderer = new StaticRenderer(gl, program);\r\n\r\n    vertexShader = webglUtils.loadFromScript(gl, vertexShaderElemAnimated, gl.VERTEX_SHADER);\r\n    fragmentShader = webglUtils.loadFromScript(gl, fragmentShaderElemAnimated, gl.FRAGMENT_SHADER);\r\n    program = webglUtils.createProgram(gl, vertexShader, fragmentShader);\r\n    animatedRenderer = new AnimatedRenderer(gl, program);\r\n\r\n    const aspect = canvasElem.clientWidth / canvasElem.clientHeight;\r\n    let yFov = degToRad(60); //To radians;\r\n    let zNear = 1;\r\n    let zFar = 2000;\r\n\r\n    firsPersonCamera.cameraObj = new Camera(\r\n        yFov,\r\n        aspect,\r\n        zNear,\r\n        zFar\r\n    );\r\n    firsPersonCamera.cameraObj.computePerspectiveMatrix();\r\n    firsPersonCamera.cameraObj.transform.position = new Vector3(-4.5, 0, -2);\r\n    firsPersonCamera.cameraObj.transform.setRotation(new Vector3(degToRad(0), degToRad(-45), degToRad(0)));\r\n    firsPersonCamera.currentRotationAngles = new Vector3(degToRad(0), degToRad(-45), degToRad(0));\r\n\r\n    scene = new Scene(\r\n        firsPersonCamera.cameraObj,\r\n        Vector3.normalize(new Vector3(0.5, 0.7, 1)),\r\n        []\r\n    );\r\n}\r\n\r\nfunction gameLoop(now: number): void {\r\n    Time.computeTime(now);\r\n    processInput();\r\n    update();\r\n    render();\r\n    requestAnimationFrame(gameLoop);\r\n}\r\n\r\nfunction processInput() {\r\n    let direction = new Vector3();\r\n    if (controls.up) direction = Vector3.add(direction, Vector3.forward);\r\n    if (controls.down) direction = Vector3.add(direction, Vector3.backward);\r\n    if (controls.right) direction = Vector3.add(direction, Vector3.right);\r\n    if (controls.left) direction = Vector3.add(direction, Vector3.left);\r\n\r\n    firsPersonCamera.Move(direction);\r\n}\r\n\r\nfunction update(): void {\r\n    scene.update();\r\n}\r\n\r\nfunction render(): void {\r\n    animatedRenderer.clear();\r\n    scene.render();\r\n}\r\n\r\nasync function loadResources() {\r\n    // return FileLoader.loadGltf(\"./assets/mannequinnWalking.gltf\", 0);\r\n    return FileLoader.loadGltf(\"./assets/whale.CYCLES.gltf\", 0);\r\n\r\n    //TODO: when we need more resources, add them here...\r\n    // when all resources finish loading, then we proceed\r\n\r\n    //Something like:\r\n    //we load everything we need to start rendering here....\r\n    //let resource01 = FileLoader.loadImage(\"./assets/someImage1.png\");\r\n    //let resource02 = FileLoader.loadImage(\"./assets/someImage2.png\");\r\n    //let resource03 = FileLoader.loadGltf(\"./assets/someScene.gltf\");\r\n    //let promises: Promise<any>[] = [resource01, resource02, resource03];\r\n    //await Promise.all(promises).then((values) => { ... });\r\n}\r\n\r\nfunction createEventHandlers(): void {\r\n    viewElements.animationSelect.addEventListener(\"change\", function (this: HTMLInputElement, event: InputEvent) {\r\n        if (animations[this.value]) {\r\n            setupAnimatedModel();\r\n            theModel.doAnimation(animations[this.value]);\r\n        } else {\r\n            setupStaticModel();\r\n        }\r\n    });\r\n\r\n    document.addEventListener(\"keydown\", function (event: KeyboardEvent) {\r\n        if (event.key === 'w') {\r\n            controls.up = true;\r\n        } else if (event.key === 's') {\r\n            controls.down = true;\r\n        } else if (event.key === 'a') {\r\n            controls.left = true;\r\n        } else if (event.key === 'd') {\r\n            controls.right = true;\r\n        } else if (event.key === 'Enter') {\r\n            //console.log(controls);\r\n        }\r\n    });\r\n    \r\n    document.addEventListener(\"keyup\", function (event: KeyboardEvent) {\r\n        if (event.key === 'w') {\r\n            controls.up = false;\r\n        } else if (event.key === 's') {\r\n            controls.down = false;\r\n        } else if (event.key === 'a') {\r\n            controls.left = false;\r\n        } else if (event.key === 'd') {\r\n            controls.right = false;\r\n        } else if (event.key === 'Enter') {\r\n            //console.log(controls);\r\n        }\r\n    });\r\n\r\n    // pointer lock object forking for cross browser\r\n    let canvas = animatedRenderer.getContext().canvas as HTMLCanvasElement;\r\n\r\n    canvas.addEventListener(\"click\", function (this: HTMLCanvasElement, event: Event) {\r\n        this.requestPointerLock();\r\n    });\r\n\r\n    document.addEventListener('pointerlockchange', pointerLockChanged);\r\n\r\n    function pointerLockChanged(): void {\r\n        if (document.pointerLockElement === canvas) {\r\n            document.addEventListener(\"mousemove\", mouseMoved);\r\n        } else {\r\n            //console.log('The pointer lock status is now unlocked');\r\n            document.removeEventListener(\"mousemove\", mouseMoved);\r\n        }\r\n    }\r\n\r\n    function mouseMoved(event: MouseEvent) {\r\n        let rotation = new Vector3(\r\n            event.movementY,\r\n            event.movementX,\r\n            0\r\n        );\r\n        firsPersonCamera.Rotate(rotation);\r\n    }\r\n}\r\n\r\nfunction showLoadingState() {\r\n    viewElements.loadingState.style.visibility = \"visible\";\r\n    viewElements.loadedState.style.visibility = \"hidden\";\r\n}\r\nfunction showLoadedState() {\r\n\r\n    viewElements.loadingState.style.visibility = \"hidden\";\r\n    viewElements.loadedState.style.visibility = \"visible\";\r\n}\r\n\r\nfunction buildAnimationOptions(animations: string[]) {\r\n    animations.forEach(animation => {\r\n        let newOption = document.createElement(\"option\") as HTMLOptionElement;\r\n        newOption.value = animation;\r\n        newOption.text = animation;\r\n        viewElements.animationSelect.appendChild(newOption);\r\n    });\r\n}\r\n\r\n// There is something weird going on with the joints, so when we use joints the orientation of the model changes(maybe it is because in blender Z is UP!)\r\n// Also when i rotate animated models, things gets weird(like, it rotates twice the desired amount, among other weird behaviours)\r\n// So, this 2 functions belows exists to work around those behaviours... hopefully i can fix the issues soon!\r\nfunction setupStaticModel() {\r\n    theModel.renderer = staticRenderer;\r\n    theModel.transform.position = new Vector3(0, -1, -7);\r\n    theModel.transform.scale = new Vector3(0.4, 0.4, 0.4);\r\n    theModel.transform.setRotation(new Vector3(0, 0, 0));\r\n}\r\n\r\nfunction setupAnimatedModel() {\r\n    theModel.renderer = animatedRenderer;\r\n    theModel.transform.position = new Vector3(0, 0.6, -3);\r\n    theModel.transform.scale = new Vector3(1, 1, 1);\r\n    theModel.transform.setRotation(new Vector3(degToRad(-45), 0, 0));\r\n}","import { Camera } from \"./camera\";\r\nimport { Model } from \"./model\";\r\nimport { TreeNode } from \"./node\";\r\nimport { Vector3 } from \"./vector\";\r\n\r\nexport class Scene {\r\n    activeCamera: Camera;\r\n    globalLightDirection: Vector3;\r\n    rootNodes: TreeNode[];\r\n    renderables: Model[];\r\n\r\n    constructor(camera?: Camera, globalLightDirection?: Vector3, nodes?: TreeNode[]) {\r\n        this.activeCamera = camera ?? null;\r\n        this.globalLightDirection = globalLightDirection ?? null;\r\n        this.rootNodes = nodes ?? [];\r\n        this.renderables = [];\r\n    }\r\n\r\n    update(): void {\r\n        this.rootNodes.forEach(rootNode => {\r\n            rootNode.updateTransforms();\r\n        });\r\n    }\r\n\r\n    render(): void {\r\n        //TODO: comeback here later\r\n        this.renderables.forEach(renderable => {\r\n            renderable.update();\r\n            renderable.render(this.activeCamera);\r\n        });\r\n    }\r\n}","import { Camera } from \"./camera\";\r\nimport { Matrix4 } from \"./matrix\";\r\nimport { BaseRenderer } from \"./renderer\";\r\nimport { StaticModel } from \"./staticModel\";\r\nimport { Vector3, Vector4 } from \"./vector\";\r\n\r\nexport class StaticRenderer extends BaseRenderer {\r\n    private positionAttributeLocation: number;\r\n    private texCoordsAttributeLocation: number;\r\n    private normalsAttributeLocation: number;\r\n\r\n    private worldMatrixUniformLocation: WebGLUniformLocation;\r\n    private viewMatrixUniformLocation: WebGLUniformLocation;\r\n    private projectionMatrixUniformLocation: WebGLUniformLocation;\r\n    private worldInverseTransposeMatrixLocation: WebGLUniformLocation;\r\n    private reverseLightDirectionLocation: WebGLUniformLocation;\r\n\r\n    constructor(context: WebGLRenderingContext, program: WebGLProgram) {\r\n        super(context, program);\r\n\r\n        this.positionAttributeLocation = context.getAttribLocation(program, \"a_position\");\r\n        this.texCoordsAttributeLocation = context.getAttribLocation(program, \"a_texcoord\");\r\n        this.normalsAttributeLocation = context.getAttribLocation(program, \"a_normal\");\r\n\r\n        this.worldMatrixUniformLocation = context.getUniformLocation(program, \"u_worldMatrix\");\r\n        this.viewMatrixUniformLocation = context.getUniformLocation(program, \"u_viewMatrix\");\r\n        this.projectionMatrixUniformLocation = context.getUniformLocation(program, \"u_projectionMatrix\");\r\n        this.worldInverseTransposeMatrixLocation = context.getUniformLocation(program, \"u_worldInverseTransposeMatrix\");\r\n        this.reverseLightDirectionLocation = context.getUniformLocation(program, \"u_reverseLightDirection\");\r\n    }\r\n\r\n    //TODO: Move this out\r\n    loadTexture(img: HTMLImageElement): WebGLTexture {\r\n        let texture = this.context.createTexture();\r\n        this.context.bindTexture(this.context.TEXTURE_2D, texture);\r\n\r\n        // Set the parameters so we can render any size image.\r\n        this.context.texParameteri(this.context.TEXTURE_2D, this.context.TEXTURE_WRAP_S, this.context.CLAMP_TO_EDGE);\r\n        this.context.texParameteri(this.context.TEXTURE_2D, this.context.TEXTURE_WRAP_T, this.context.CLAMP_TO_EDGE);\r\n        this.context.texParameteri(this.context.TEXTURE_2D, this.context.TEXTURE_MIN_FILTER, this.context.NEAREST);\r\n        this.context.texParameteri(this.context.TEXTURE_2D, this.context.TEXTURE_MAG_FILTER, this.context.NEAREST);\r\n\r\n        // Upload the image into the texture.\r\n        this.context.texImage2D(this.context.TEXTURE_2D, 0, this.context.RGBA, this.context.RGBA, this.context.UNSIGNED_BYTE, img);\r\n        this.context.generateMipmap(this.context.TEXTURE_2D);\r\n\r\n        return texture;\r\n    }\r\n\r\n    //TODO: Move this out\r\n    loadTexture2(color: Vector4) {\r\n        let texture = this.context.createTexture();\r\n        this.context.bindTexture(this.context.TEXTURE_2D, texture);\r\n\r\n        // Set the parameters so we can render any size image.\r\n        this.context.texParameteri(this.context.TEXTURE_2D, this.context.TEXTURE_WRAP_S, this.context.CLAMP_TO_EDGE);\r\n        this.context.texParameteri(this.context.TEXTURE_2D, this.context.TEXTURE_WRAP_T, this.context.CLAMP_TO_EDGE);\r\n        this.context.texParameteri(this.context.TEXTURE_2D, this.context.TEXTURE_MIN_FILTER, this.context.NEAREST);\r\n        this.context.texParameteri(this.context.TEXTURE_2D, this.context.TEXTURE_MAG_FILTER, this.context.NEAREST);\r\n\r\n        // Upload the image into the texture.\r\n        this.context.texImage2D(this.context.TEXTURE_2D, 0, this.context.RGBA, 1, 1, 0, this.context.RGBA, this.context.UNSIGNED_BYTE,\r\n            new Uint8Array([0, 0, 255, 255]));\r\n        //this.context.generateMipmap(this.context.TEXTURE_2D);\r\n\r\n        return texture;\r\n    }\r\n\r\n    clear() {\r\n        this.context.clearColor(0.5, 0.5, 0.5, 1);\r\n        this.context.clear(this.context.COLOR_BUFFER_BIT | this.context.DEPTH_BUFFER_BIT);\r\n    }\r\n\r\n    render(model: StaticModel, camera: Camera): void {\r\n        let projectionMatrix = camera.getPerspectiveMatrix();\r\n        let viewMatrix = Matrix4.makeViewMatrix(\r\n            camera.transform.position,\r\n            Vector3.add(camera.transform.position, camera.transform.forward),\r\n            Vector3.up);\r\n\r\n        // Tell WebGL how to convert from clip space to pixels\r\n        this.context.viewport(0, 0, this.context.canvas.width, this.context.canvas.height);\r\n        this.context.useProgram(this.program);\r\n        this.context.enable(this.context.CULL_FACE);\r\n        this.context.enable(this.context.DEPTH_TEST);\r\n\r\n        //set uniforms\r\n        this.context.uniformMatrix4fv(this.worldMatrixUniformLocation, false, model.transform.getWorldMatrix().flatten());\r\n        this.context.uniformMatrix4fv(this.projectionMatrixUniformLocation, false, projectionMatrix.flatten());\r\n        this.context.uniformMatrix4fv(this.viewMatrixUniformLocation, false, viewMatrix.flatten());\r\n\r\n        let worldInverse = Matrix4.inverse(model.transform.getWorldMatrix());\r\n        this.context.uniformMatrix4fv(this.worldInverseTransposeMatrixLocation, false, Matrix4.transpose(worldInverse).flatten());\r\n        //TODO: use the light from Scene object\r\n        let reverseLightDirectionVector = Vector3.normalize(new Vector3(0.5, 0.7, 1));\r\n        this.context.uniform3fv(\r\n            this.reverseLightDirectionLocation,\r\n            new Float32Array([\r\n                reverseLightDirectionVector.x,\r\n                reverseLightDirectionVector.y,\r\n                reverseLightDirectionVector.z])\r\n        );\r\n\r\n        //bind buffers\r\n        this.context.bindBuffer(this.context.ARRAY_BUFFER, model.positions);\r\n        this.context.enableVertexAttribArray(this.positionAttributeLocation);\r\n        //Tell the position attribute how to get data out of positionBuffer (ARRAY_BUFFER)\r\n        this.context.vertexAttribPointer(\r\n            this.positionAttributeLocation,\r\n            3,          // we are passing 3 components per iteration\r\n            this.context.FLOAT,   // the type of each component\r\n            false,      // should normalize?\r\n            0,          // 0 = move forward size * sizeof(type) each iteration to get the next position\r\n            0           // 0 = start at the beginning of the buffer\r\n        );\r\n\r\n        this.context.bindBuffer(this.context.ARRAY_BUFFER, model.textureCoords);\r\n        this.context.enableVertexAttribArray(this.texCoordsAttributeLocation);\r\n        this.context.vertexAttribPointer(\r\n            this.texCoordsAttributeLocation,\r\n            2,         // we are passing 2 components per iteration\r\n            this.context.FLOAT,  // the type of each component\r\n            false,     // should normalize?\r\n            0,         // 0 = move forward size * sizeof(type) each iteration to get the next position\r\n            0          // 0 = start at the beginning of the buffer\r\n        );\r\n\r\n        this.context.bindBuffer(this.context.ARRAY_BUFFER, model.normals);\r\n        this.context.enableVertexAttribArray(this.normalsAttributeLocation);\r\n        this.context.vertexAttribPointer(\r\n            this.normalsAttributeLocation,\r\n            3,         // we are passing 3 components per iteration\r\n            this.context.FLOAT,  // the type of each component\r\n            false,     // should normalize?\r\n            0,         // 0 = move forward size * sizeof(type) each iteration to get the next position\r\n            0          // 0 = start at the beginning of the buffer\r\n        );\r\n\r\n        this.context.activeTexture(this.context.TEXTURE0);\r\n        this.context.bindTexture(this.context.TEXTURE_2D, model.texture);\r\n\r\n\r\n        this.context.drawElements(\r\n            WebGLRenderingContext.TRIANGLES,\r\n            model.indexCount,\r\n            this.context.UNSIGNED_SHORT,\r\n            0\r\n        );\r\n    }\r\n}"],"sourceRoot":""}